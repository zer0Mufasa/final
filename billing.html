<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing & Subscription | Fixology</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîß</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: rgba(255, 255, 255, 0.03);
      --border-color: rgba(255, 255, 255, 0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.5);
      --accent-purple: #a78bfa;
      --accent-cyan: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gradient-primary: linear-gradient(135deg, #a78bfa 0%, #06b6d4 100%);
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: rgba(10, 10, 15, 0.95);
      border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(20px);
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); text-decoration: none; }
    .logo-icon { width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .nav-links { display: flex; gap: 2rem; list-style: none; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .nav-links a:hover { color: var(--accent-purple); }
    
    .container { max-width: 1000px; margin: 0 auto; padding: 3rem 2rem; }
    
    .page-header { margin-bottom: 3rem; }
    .page-title { font-family: 'Space Grotesk', sans-serif; font-size: 2.5rem; font-weight: 700; margin-bottom: 0.75rem; }
    .page-subtitle { color: var(--text-secondary); font-size: 1.125rem; }
    
    .billing-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
    
    .billing-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; }
    .billing-card h3 { font-family: 'Space Grotesk', sans-serif; font-size: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
    
    .current-plan { background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), rgba(6, 182, 212, 0.1)); border-color: rgba(167, 139, 250, 0.3); }
    .plan-badge { display: inline-flex; padding: 0.5rem 1rem; background: var(--gradient-primary); border-radius: 20px; font-size: 0.875rem; font-weight: 600; }
    
    .plan-details { margin-top: 1.5rem; }
    .plan-detail { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
    .plan-detail:last-child { border-bottom: none; }
    .plan-label { color: var(--text-secondary); }
    .plan-value { font-weight: 600; }
    
    .usage-bar { height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
    .usage-fill { height: 100%; background: var(--gradient-primary); border-radius: 4px; transition: width 0.5s; }
    
    .invoice-list { list-style: none; }
    .invoice-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 8px; transition: background 0.2s; }
    .invoice-item:hover { background: var(--bg-card); }
    .invoice-date { color: var(--text-muted); font-size: 0.875rem; }
    .invoice-amount { font-weight: 600; }
    .invoice-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .status-paid { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .status-pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    
    .payment-method { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 10px; margin-top: 1rem; }
    .card-icon { font-size: 2rem; }
    .card-details { flex: 1; }
    .card-number { font-family: monospace; }
    .card-expiry { font-size: 0.875rem; color: var(--text-muted); }
    
    .btn { padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--gradient-primary); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(167, 139, 250, 0.3); }
    .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #f87171; }
    
    .sidebar-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .sidebar-card h4 { font-family: 'Space Grotesk', sans-serif; margin-bottom: 1rem; }
    
    .quick-stat { text-align: center; padding: 1rem; }
    .quick-stat-value { font-family: 'Space Grotesk', sans-serif; font-size: 2rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .quick-stat-label { font-size: 0.875rem; color: var(--text-muted); }
    
    .help-link { display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); transition: color 0.2s; }
    .help-link:hover { color: var(--accent-purple); }
    .help-link:last-child { border-bottom: none; }
    
    @media (max-width: 768px) {
      .billing-grid { grid-template-columns: 1fr; }
      .container { padding: 2rem 1rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="logo"><span class="logo-icon">üîß</span><span>Fixology</span></a>
    <ul class="nav-links">
      <li><a href="dashboard/repairs.html">Dashboard</a></li>
      <li><a href="billing.html" style="color: var(--accent-purple);">Billing</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">üí≥ Billing & Subscription</h1>
      <p class="page-subtitle">Manage your subscription, payment methods, and invoices</p>
    </div>

    <div class="billing-grid">
      <div class="main-content">
        <div class="billing-card current-plan">
          <h3>üì¶ Current Plan</h3>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="plan-badge" id="plan-name">Free Plan</span>
              <p style="color: var(--text-secondary); margin-top: 0.75rem;" id="plan-description">Basic features for getting started</p>
            </div>
            <a href="upgrade.html" class="btn btn-primary">Upgrade Plan</a>
          </div>
          
          <div class="plan-details">
            <div class="plan-detail">
              <span class="plan-label">IMEI Checks Used</span>
              <span class="plan-value"><span id="imei-used">0</span> / <span id="imei-limit">10</span></span>
            </div>
            <div class="usage-bar">
              <div class="usage-fill" id="usage-bar" style="width: 0%;"></div>
            </div>
            <div class="plan-detail">
              <span class="plan-label">Renewal Date</span>
              <span class="plan-value" id="renewal-date">N/A</span>
            </div>
            <div class="plan-detail">
              <span class="plan-label">Monthly Cost</span>
              <span class="plan-value" id="monthly-cost">$0.00</span>
            </div>
          </div>
        </div>

        <div class="billing-card">
          <h3>üí≥ Payment Method</h3>
          <div id="payment-method">
            <p style="color: var(--text-muted);">No payment method on file</p>
          </div>
          <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="addPaymentMethod()">Add Payment Method</button>
        </div>

        <div class="billing-card">
          <h3>üìÑ Billing History</h3>
          <ul class="invoice-list" id="invoice-list">
            <li style="color: var(--text-muted); padding: 1rem;">No invoices yet</li>
          </ul>
        </div>

        <div class="billing-card">
          <h3>‚ö†Ô∏è Danger Zone</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">Cancel your subscription or delete your account</p>
          <button class="btn btn-danger" onclick="cancelSubscription()">Cancel Subscription</button>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-card">
          <h4>üìä Usage This Month</h4>
          <div class="quick-stat">
            <div class="quick-stat-value" id="total-checks">0</div>
            <div class="quick-stat-label">IMEI Checks</div>
          </div>
        </div>

        <div class="sidebar-card">
          <h4>üéÅ Need Help?</h4>
          <a href="support.html" class="help-link">üìß Contact Support</a>
          <a href="docs.html" class="help-link">üìö Documentation</a>
          <a href="terms.html" class="help-link">üìã Terms of Service</a>
          <a href="privacy.html" class="help-link">üîí Privacy Policy</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://final-bice-phi.vercel.app';
    const token = localStorage.getItem('fixology_shop_token') || localStorage.getItem('fixology_token');

    if (!token) {
      window.location.href = 'shop-login.html?redirect=billing.html';
    }

    const planLimits = {
      free: { imei: 10, price: 0 },
      basic: { imei: 100, price: 29 },
      pro: { imei: 400, price: 79 },
      enterprise: { imei: 999999, price: 199 }
    };

    async function loadBillingInfo() {
      try {
        const response = await fetch(`${API_BASE}/api/shops/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success && data.shop) {
          const shop = data.shop;
          const plan = shop.subscriptionPlan || 'free';
          const limits = planLimits[plan];

          // Update plan info
          document.getElementById('plan-name').textContent = 
            plan === 'free' ? 'Free Plan' :
            plan === 'basic' ? 'üöÄ Basic Plan' :
            plan === 'pro' ? 'üíé Pro Plan' : 'üè¢ Enterprise';
          
          document.getElementById('plan-description').textContent = 
            plan === 'free' ? 'Basic features for getting started' :
            plan === 'basic' ? '100 IMEI checks per month' :
            plan === 'pro' ? '400 IMEI checks per month + priority support' : 
            'Unlimited everything + dedicated support';

          // Usage
          const imeiUsed = shop.imeiChecksUsed || 0;
          document.getElementById('imei-used').textContent = imeiUsed;
          document.getElementById('imei-limit').textContent = limits.imei === 999999 ? '‚àû' : limits.imei;
          document.getElementById('total-checks').textContent = imeiUsed;
          
          const usagePercent = limits.imei === 999999 ? 0 : Math.min((imeiUsed / limits.imei) * 100, 100);
          document.getElementById('usage-bar').style.width = usagePercent + '%';

          // Cost
          document.getElementById('monthly-cost').textContent = '$' + limits.price + '.00';
          
          // Renewal
          if (shop.renewalDate) {
            document.getElementById('renewal-date').textContent = new Date(shop.renewalDate).toLocaleDateString();
          }

          // Payment method
          if (shop.paymentMethod) {
            document.getElementById('payment-method').innerHTML = `
              <div class="payment-method">
                <span class="card-icon">üí≥</span>
                <div class="card-details">
                  <div class="card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${shop.paymentMethod.last4}</div>
                  <div class="card-expiry">Expires ${shop.paymentMethod.expMonth}/${shop.paymentMethod.expYear}</div>
                </div>
                <button class="btn btn-secondary" onclick="updatePaymentMethod()">Update</button>
              </div>
            `;
          }
        }
      } catch (err) {
        console.error('Error loading billing:', err);
      }
    }

    async function addPaymentMethod() {
      try {
        const response = await fetch(`${API_BASE}/api/billing/create-session`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` 
          },
          body: JSON.stringify({ mode: 'setup' })
        });
        const data = await response.json();
        
        if (data.url) {
          window.location.href = data.url;
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Failed to open payment setup');
      }
    }

    function updatePaymentMethod() {
      addPaymentMethod();
    }

    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.')) {
        return;
      }
      
      alert('Please contact support@fixologyai.com to cancel your subscription.');
    }

    function logout() {
      localStorage.removeItem('fixology_shop_token');
      localStorage.removeItem('fixology_token');
      window.location.href = 'index.html';
    }

    loadBillingInfo();
  </script>
</body>
</html>

