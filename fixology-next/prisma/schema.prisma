// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // Use a direct (non-pgbouncer) connection for migrations/introspection.
  // Keep DATABASE_URL pointed at the Supabase pooler (port 6543) for app runtime.
  directUrl = env("DIRECT_URL")
}

// ============================================================
// PLATFORM LEVEL (Fixology owns these)
// ============================================================

model PlatformAdmin {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String       @map("password_hash")
  name         String
  role         PlatformRole @default(SUPPORT)
  avatarUrl    String?      @map("avatar_url")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Admin system relations (CEO portal)
  auditLogs          AdminAuditLog[]
  announcements      Announcement[]      @relation("AnnouncementCreator")
  shopNotes          ShopNote[]
  templates          ShopTemplate[]      @relation("TemplateCreator")
  cloneHistory       CloneHistory[]      @relation("CloneHistoryAdmin")
  emailBroadcasts    EmailBroadcast[]    @relation("EmailBroadcastCreator")
  alertRules         AlertRule[]         @relation("AlertRuleCreator")
  segments           Segment[]           @relation("SegmentCreator")
  experiments        Experiment[]        @relation("ExperimentCreator")
  maintenanceWindows MaintenanceWindow[] @relation("MaintenanceCreator")
  adminBookmarks     AdminBookmark[]
  apiKeys            ApiKey[]            @relation("ApiKeyCreator")

  @@map("platform_admins")
}

enum PlatformRole {
  SUPER_ADMIN // Mufasa - god mode
  SUPPORT // Customer support
  BILLING // Billing/finance
}

// ============================================================
// CEO ADMIN PORTAL MODELS (platform-wide)
// ============================================================

model AdminAuditLog {
  id      String        @id @default(cuid())
  adminId String        @map("admin_id")
  admin   PlatformAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  action     String
  targetType String  @map("target_type")
  targetId   String? @map("target_id")

  description String?
  metadata    Json?
  ipAddress   String? @map("ip_address")
  userAgent   String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

model Announcement {
  id      String           @id @default(cuid())
  title   String
  content String           @db.Text
  type    AnnouncementType @default(INFO)

  // Targeting
  targetPlans String[] @default([]) @map("target_plans")
  targetShops String[] @default([]) @map("target_shops")

  // Display
  dismissible Boolean @default(true)
  showBanner  Boolean @default(true) @map("show_banner")

  // Schedule
  startsAt DateTime  @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  isActive Boolean @default(true) @map("is_active")

  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("AnnouncementCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([startsAt])
  @@index([endsAt])
  @@index([isActive])
  @@map("announcements")
}

// ============================================================
// PHASE 1: CLONE CENTER, TAGS, EMAILS, ALERTS
// ============================================================

model ShopTemplate {
  id          String        @id @default(cuid())
  name        String
  description String?       @db.Text
  category    String? // 'starter', 'pro', 'enterprise', 'custom'
  config      Json // Full shop config snapshot
  isDefault   Boolean       @default(false) @map("is_default")
  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([category])
  @@index([isDefault])
  @@map("shop_templates")
}

model CloneHistory {
  id               String        @id @default(cuid())
  sourceShopId     String?       @map("source_shop_id")
  sourceType       String        @map("source_type") // 'shop' | 'template'
  sourceTemplateId String?       @map("source_template_id")
  targetShopId     String        @map("target_shop_id")
  clonedFields     String[]      @map("cloned_fields") // What was cloned
  adminId          String        @map("admin_id")
  admin            PlatformAdmin @relation("CloneHistoryAdmin", fields: [adminId], references: [id])
  createdAt        DateTime      @default(now()) @map("created_at")

  @@index([sourceShopId])
  @@index([targetShopId])
  @@index([adminId])
  @@map("clone_history")
}

model ShopTag {
  id        String              @id @default(cuid())
  name      String              @unique
  color     String              @default("#8884d8")
  shops     ShopTagAssignment[]
  createdAt DateTime            @default(now()) @map("created_at")

  @@map("shop_tags")
}

model ShopTagAssignment {
  id        String   @id @default(cuid())
  shopId    String   @map("shop_id")
  tagId     String   @map("tag_id")
  tag       ShopTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  shop      Shop     @relation("ShopTags", fields: [shopId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([shopId, tagId])
  @@index([shopId])
  @@index([tagId])
  @@map("shop_tag_assignments")
}

model Segment {
  id        String   @id @default(cuid())
  name      String
  rules     Json // Array of filter rules
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("SegmentCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@map("segments")
}

model EmailBroadcast {
  id            String        @id @default(cuid())
  subject       String
  content       String        @db.Text
  recipientType String        @map("recipient_type") // 'all', 'segment', 'shops', 'plans'
  recipientIds  String[]      @map("recipient_ids")
  segmentId     String?       @map("segment_id")
  status        String        @default("draft") // draft, scheduled, sending, sent
  scheduledAt   DateTime?     @map("scheduled_at")
  sentAt        DateTime?     @map("sent_at")
  stats         Json? // opens, clicks, bounces
  createdById   String        @map("created_by_id")
  createdBy     PlatformAdmin @relation("EmailBroadcastCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([status])
  @@index([scheduledAt])
  @@index([createdById])
  @@map("email_broadcasts")
}

model AlertRule {
  id              String    @id @default(cuid())
  name            String
  condition       Json // Rule definition
  channels        String[] // email, sms, slack
  recipients      String[] // Admin email addresses
  cooldownMinutes Int       @default(60) @map("cooldown_minutes")
  isActive        Boolean   @default(true) @map("is_active")
  lastTriggered   DateTime? @map("last_triggered")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("AlertRuleCreator", fields: [createdById], references: [id], onDelete: Cascade)

  alerts Alert[]

  @@index([isActive])
  @@index([createdById])
  @@map("alert_rules")
}

model Alert {
  id             String    @id @default(cuid())
  ruleId         String    @map("rule_id")
  rule           AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  status         String    @default("active") // active, acknowledged, resolved, snoozed
  message        String    @db.Text
  data           Json?
  acknowledgedBy String?   @map("acknowledged_by")
  acknowledgedAt DateTime? @map("acknowledged_at")
  resolvedBy     String?   @map("resolved_by")
  resolvedAt     DateTime? @map("resolved_at")
  snoozedUntil   DateTime? @map("snoozed_until")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([ruleId])
  @@index([status])
  @@index([createdAt])
  @@map("alerts")
}

// ============================================================
// ADDITIONAL ADMIN FEATURES
// ============================================================

model DiscountCode {
  id         String       @id @default(cuid())
  code       String       @unique
  type       DiscountType @default(PERCENTAGE)
  amount     Int // percentage or cents
  maxUses    Int?         @map("max_uses")
  usedCount  Int          @default(0) @map("used_count")
  validPlans String[]     @default([]) @map("valid_plans")
  expiresAt  DateTime?    @map("expires_at")
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("discount_codes")
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Webhook {
  id            String    @id @default(cuid())
  url           String
  events        String[] // shop.created, payment.succeeded, etc.
  secret        String? // For signature verification
  isActive      Boolean   @default(true) @map("is_active")
  lastTriggered DateTime? @map("last_triggered")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  deliveries WebhookDelivery[]

  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String    @id @default(cuid())
  webhookId   String    @map("webhook_id")
  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  event       String
  payload     Json
  status      String    @default("pending") // pending, success, failed
  statusCode  Int?      @map("status_code")
  response    String?   @db.Text
  attempts    Int       @default(0)
  nextRetryAt DateTime? @map("next_retry_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model ScheduledReport {
  id         String    @id @default(cuid())
  name       String
  type       String // revenue, signups, churn, etc.
  schedule   String // daily, weekly, monthly
  recipients String[] // Admin email addresses
  format     String[]  @default(["pdf"]) // pdf, csv, both
  isActive   Boolean   @default(true) @map("is_active")
  lastRunAt  DateTime? @map("last_run_at")
  nextRunAt  DateTime? @map("next_run_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  runs ReportRun[]

  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model ReportRun {
  id          String          @id @default(cuid())
  reportId    String          @map("report_id")
  report      ScheduledReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  status      String          @default("pending") // pending, generating, completed, failed
  fileUrl     String?         @map("file_url")
  error       String?         @db.Text
  startedAt   DateTime        @default(now()) @map("started_at")
  completedAt DateTime?       @map("completed_at")

  @@index([reportId])
  @@index([status])
  @@map("report_runs")
}

model Integration {
  id          String    @id @default(cuid())
  service     String    @unique // stripe, twilio, sendgrid, etc.
  config      Json // API keys, settings
  isActive    Boolean   @default(true) @map("is_active")
  lastCheckAt DateTime? @map("last_check_at")
  status      String    @default("unknown") // healthy, degraded, down
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("integrations")
}

model Experiment {
  id            String        @id @default(cuid())
  name          String
  hypothesis    String?       @db.Text
  metric        String // What we're measuring
  variants      Json // Array of variant configs
  allocation    Json // Traffic allocation
  targetSegment String?       @map("target_segment")
  status        String        @default("draft") // draft, running, paused, completed
  startedAt     DateTime?     @map("started_at")
  endedAt       DateTime?     @map("ended_at")
  results       Json? // Statistical results
  winner        String? // Winning variant
  createdById   String        @map("created_by_id")
  createdBy     PlatformAdmin @relation("ExperimentCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdById])
  @@map("experiments")
}

model ChangelogEntry {
  id           String    @id @default(cuid())
  version      String
  title        String
  content      String    @db.Text
  features     String[]  @default([])
  improvements String[]  @default([])
  fixes        String[]  @default([])
  publishedAt  DateTime? @map("published_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([publishedAt])
  @@map("changelog_entries")
}

model MaintenanceWindow {
  id          String        @id @default(cuid())
  title       String
  message     String?       @db.Text
  startAt     DateTime      @map("start_at")
  endAt       DateTime?     @map("end_at")
  status      String        @default("scheduled") // scheduled, active, completed
  allowedIps  String[]      @default([]) @map("allowed_ips")
  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("MaintenanceCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([status])
  @@index([startAt])
  @@map("maintenance_windows")
}

enum AnnouncementType {
  INFO
  WARNING
  MAINTENANCE
  FEATURE
  PROMOTION
}

model FeatureFlag {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?

  enabled       Boolean  @default(false)
  enabledForAll Boolean  @default(false) @map("enabled_for_all")
  enabledPlans  String[] @default([]) @map("enabled_plans")
  enabledShops  String[] @default([]) @map("enabled_shops")
  percentage    Int?     @map("percentage")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

model PlatformSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("platform_settings")
}

model ShopNote {
  id      String @id @default(cuid())
  shopId  String @map("shop_id")
  adminId String @map("admin_id")

  content String @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop  Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  admin PlatformAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([adminId])
  @@map("shop_notes")
}

// ============================================================
// SHOP LEVEL (Each repair shop)
// ============================================================

model Shop {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique // fixologyai.com/shop/[slug]
  email    String
  phone    String?
  address  String?
  city     String?
  state    String?
  zip      String?
  country  String  @default("US")
  timezone String  @default("America/Chicago")
  currency String  @default("USD")
  logoUrl  String? @map("logo_url")

  // Onboarding
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  businessHours         Json      @default("{}") @map("business_hours")
  repairFocus           String[]  @default([]) @map("repair_focus")

  // Subscription
  plan                 SubscriptionPlan @default(FREE)
  stripeCustomerId     String?          @unique @map("stripe_customer_id")
  stripeSubscriptionId String?          @unique @map("stripe_subscription_id")
  status               ShopStatus       @default(TRIAL)
  trialEndsAt          DateTime?        @map("trial_ends_at")

  // Feature flags (JSON for flexibility)
  features Json @default("{\"max_tickets\": 25, \"max_users\": 1, \"max_customers\": 100, \"sms\": false, \"ai\": false, \"workflows\": false}")

  // IMEI Deep Scan Credits
  imeiCredits Int @default(0) @map("imei_credits")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users          ShopUser[]
  timeEntries    TimeEntry[]
  customers      Customer[]
  tickets        Ticket[]
  inventory      InventoryItem[]
  invoices       Invoice[]
  messages       Message[]
  appointments   Appointment[]
  workflows      Workflow[]
  notes          ShopNote[]
  tagAssignments ShopTagAssignment[] @relation("ShopTags")

  @@map("shops")
}

enum SubscriptionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum ShopStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELLED
}

model ShopUser {
  id           String     @id @default(cuid())
  shopId       String     @map("shop_id")
  email        String
  passwordHash String     @map("password_hash")
  name         String
  role         ShopRole   @default(TECHNICIAN)
  phone        String?
  avatarUrl    String?    @map("avatar_url")
  permissions  Json       @default("{}")
  status       UserStatus @default(ACTIVE)
  lastLoginAt  DateTime?  @map("last_login_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  shop           Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  tickets        Ticket[]    @relation("AssignedTechnician")
  createdTickets Ticket[]    @relation("TicketCreator")
  timeEntries    TimeEntry[]

  @@unique([shopId, email])
  @@map("shop_users")
}

enum ShopRole {
  OWNER // Full access, billing
  MANAGER // Full access except billing
  TECHNICIAN // Tickets, inventory, customers
  FRONT_DESK // Intake, customers, basic tickets
}

enum UserStatus {
  ACTIVE
  INVITED
  DISABLED
}

// ============================================================
// SHOP DATA (All have shop_id for isolation)
// ============================================================

model Customer {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  // Contact info
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String?
  phone     String
  address   String?
  city      String?
  state     String?
  zip       String?

  // Metadata
  notes       String?
  tags        String[] @default([])
  isVip       Boolean  @default(false) @map("is_vip")
  totalSpent  Decimal  @default(0) @map("total_spent") @db.Decimal(10, 2)
  ticketCount Int      @default(0) @map("ticket_count")

  // Communication preferences
  smsOptIn   Boolean @default(true) @map("sms_opt_in")
  emailOptIn Boolean @default(true) @map("email_opt_in")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop     Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  tickets  Ticket[]
  invoices Invoice[]
  messages Message[]

  @@index([shopId])
  @@map("customers")
}

model Ticket {
  id           String @id @default(cuid())
  shopId       String @map("shop_id")
  ticketNumber String @map("ticket_number") // FIX-0001

  // Customer & Device
  customerId   String  @map("customer_id")
  deviceType   String  @map("device_type") // iPhone 14 Pro
  deviceBrand  String  @map("device_brand") // Apple
  deviceModel  String? @map("device_model")
  deviceColor  String? @map("device_color")
  imei         String?
  serialNumber String? @map("serial_number")
  passcode     String?

  // Issue
  issueDescription String   @map("issue_description")
  symptoms         String[] @default([])
  diagnosis        String?
  resolution       String?

  // Status
  status   TicketStatus   @default(INTAKE)
  priority TicketPriority @default(NORMAL)

  // Assignment
  assignedToId String? @map("assigned_to_id")
  createdById  String  @map("created_by_id")

  // Pricing
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(10, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(10, 2)

  // Dates
  intakeAt    DateTime  @default(now()) @map("intake_at")
  diagnosedAt DateTime? @map("diagnosed_at")
  repairedAt  DateTime? @map("repaired_at")
  completedAt DateTime? @map("completed_at")
  pickedUpAt  DateTime? @map("picked_up_at")
  dueAt       DateTime? @map("due_at")

  // Waiver
  waiverSigned    Boolean   @default(false) @map("waiver_signed")
  waiverSignedAt  DateTime? @map("waiver_signed_at")
  waiverSignature String?   @map("waiver_signature") // Base64 signature

  // AI & Risk Intelligence
  aiDraft    Json? @map("ai_draft") // AI intake draft data
  riskReport Json? @map("risk_report") // IMEI risk check results

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop          Shop                  @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer      Customer              @relation(fields: [customerId], references: [id])
  assignedTo    ShopUser?             @relation("AssignedTechnician", fields: [assignedToId], references: [id])
  createdBy     ShopUser              @relation("TicketCreator", fields: [createdById], references: [id])
  invoice       Invoice?
  parts         TicketPart[]
  notes         TicketNote[]
  statusHistory TicketStatusHistory[]
  photos        TicketPhoto[]

  @@unique([shopId, ticketNumber])
  @@index([shopId])
  @@index([status])
  @@map("tickets")
}

enum TicketStatus {
  INTAKE
  DIAGNOSED
  WAITING_PARTS
  IN_PROGRESS
  READY
  PICKED_UP
  CANCELLED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model TicketPart {
  id          String  @id @default(cuid())
  ticketId    String  @map("ticket_id")
  inventoryId String  @map("inventory_id")
  quantity    Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)

  ticket    Ticket        @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  inventory InventoryItem @relation(fields: [inventoryId], references: [id])

  @@map("ticket_parts")
}

model TicketNote {
  id         String   @id @default(cuid())
  ticketId   String   @map("ticket_id")
  userId     String   @map("user_id")
  content    String
  isInternal Boolean  @default(true) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_notes")
}

model TicketPhoto {
  id        String   @id @default(cuid())
  ticketId  String   @map("ticket_id")
  url       String
  caption   String?
  type      String   @default("intake") // intake, diagnosis, completion
  createdAt DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_photos")
}

model TicketStatusHistory {
  id          String        @id @default(cuid())
  ticketId    String        @map("ticket_id")
  fromStatus  TicketStatus? @map("from_status")
  toStatus    TicketStatus  @map("to_status")
  changedById String        @map("changed_by_id")
  note        String?
  createdAt   DateTime      @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_status_history")
}

model InventoryItem {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  // Basic info
  name        String
  sku         String?
  description String?
  // Default allows adding this required column to existing databases safely.
  category    InventoryCategory @default(PARTS)

  // Pricing
  costPrice Decimal? @map("cost_price") @db.Decimal(10, 2)
  sellPrice Decimal  @map("sell_price") @db.Decimal(10, 2)

  // Stock
  quantity Int     @default(0)
  minStock Int     @default(0) @map("min_stock")
  maxStock Int?    @map("max_stock")
  location String? // Shelf A, Bin 3, etc.

  // Metadata
  brand    String?
  model    String?
  imageUrl String? @map("image_url")
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  ticketParts  TicketPart[]
  invoiceItems InvoiceItem[]

  @@unique([shopId, sku])
  @@index([shopId])
  @@map("inventory_items")
}

enum InventoryCategory {
  PARTS
  SERVICES
  ACCESSORIES
  DEVICES
  TOOLS
  PREPAID
}

model Invoice {
  id            String @id @default(cuid())
  shopId        String @map("shop_id")
  invoiceNumber String @map("invoice_number") // INV-0001

  customerId String  @map("customer_id")
  ticketId   String? @unique @map("ticket_id")

  // Amounts
  subtotal   Decimal @db.Decimal(10, 2)
  taxRate    Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount  Decimal @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discount   Decimal @default(0) @db.Decimal(10, 2)
  total      Decimal @db.Decimal(10, 2)
  amountPaid Decimal @default(0) @map("amount_paid") @db.Decimal(10, 2)
  amountDue  Decimal @map("amount_due") @db.Decimal(10, 2)

  // Status
  status InvoiceStatus @default(DRAFT)

  // Dates
  issuedAt DateTime? @map("issued_at")
  dueAt    DateTime? @map("due_at")
  paidAt   DateTime? @map("paid_at")

  // Payment
  paymentMethod         PaymentMethod? @map("payment_method")
  stripePaymentIntentId String?        @map("stripe_payment_intent_id")

  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop     Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer Customer      @relation(fields: [customerId], references: [id])
  ticket   Ticket?       @relation(fields: [ticketId], references: [id])
  items    InvoiceItem[]
  payments Payment[]

  @@unique([shopId, invoiceNumber])
  @@index([shopId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  CHECK
  OTHER
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String  @map("invoice_id")
  inventoryId String? @map("inventory_id")

  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  invoice   Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  inventory InventoryItem? @relation(fields: [inventoryId], references: [id])

  @@map("invoice_items")
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String        @map("invoice_id")
  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  reference String? // Check number, transaction ID, etc.
  notes     String?
  createdAt DateTime      @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Message {
  id         String @id @default(cuid())
  shopId     String @map("shop_id")
  customerId String @map("customer_id")

  direction MessageDirection
  channel   MessageChannel
  content   String

  // External IDs
  twilioSid String? @map("twilio_sid")

  status      MessageStatus @default(PENDING)
  sentAt      DateTime?     @map("sent_at")
  deliveredAt DateTime?     @map("delivered_at")
  readAt      DateTime?     @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  shop     Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id])

  @@index([shopId])
  @@index([customerId])
  @@map("messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageChannel {
  SMS
  EMAIL
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model Appointment {
  id         String  @id @default(cuid())
  shopId     String  @map("shop_id")
  customerId String? @map("customer_id")

  title       String
  description String?
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")

  status AppointmentStatus @default(SCHEDULED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model TimeEntry {
  id     String @id @default(cuid())
  userId String @map("user_id")
  shopId String @map("shop_id")

  clockIn      DateTime  @map("clock_in")
  clockOut     DateTime? @map("clock_out")
  breakMinutes Int       @default(0) @map("break_minutes")
  notes        String?
  openedShop   Boolean   @default(false) @map("opened_shop")
  closedShop   Boolean   @default(false) @map("closed_shop")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user ShopUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

model Workflow {
  id     String @id @default(cuid())
  shopId String @map("shop_id")

  name        String
  description String?
  isActive    Boolean @default(true) @map("is_active")

  // Trigger
  trigger Json // { type: "ticket_status_changed", conditions: {...} }

  // Actions
  actions Json // [{ type: "send_sms", config: {...} }, ...]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@map("workflows")
}

// ============================================================
// MISSING ADMIN FEATURES
// ============================================================

model AdminBookmark {
  id         String        @id @default(cuid())
  adminId    String        @map("admin_id")
  admin      PlatformAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)
  targetType String        @map("target_type") // shop, user, ticket
  targetId   String        @map("target_id")
  label      String? // Custom label
  createdAt  DateTime      @default(now()) @map("created_at")

  @@unique([adminId, targetType, targetId])
  @@index([adminId])
  @@map("admin_bookmarks")
}

model ApiKey {
  id          String        @id @default(cuid())
  name        String
  keyHash     String        @unique @map("key_hash") // Hashed API key
  keyPrefix   String        @map("key_prefix") // First 8 chars for display
  permissions String[]      @default([]) // Scopes: read, write, admin
  rateLimit   Int?          @map("rate_limit") // Requests per minute
  lastUsedAt  DateTime?     @map("last_used_at")
  expiresAt   DateTime?     @map("expires_at")
  isActive    Boolean       @default(true) @map("is_active")
  createdById String        @map("created_by_id")
  createdBy   PlatformAdmin @relation("ApiKeyCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([createdById])
  @@index([isActive])
  @@map("api_keys")
}

model NPSSurvey {
  id        String   @id @default(cuid())
  shopId    String?  @map("shop_id")
  userId    String?  @map("user_id")
  score     Int // 0-10
  comment   String?  @db.Text
  category  String? // promoter (9-10), passive (7-8), detractor (0-6)
  metadata  Json? // Additional context
  createdAt DateTime @default(now()) @map("created_at")

  @@index([shopId])
  @@index([score])
  @@index([createdAt])
  @@map("nps_surveys")
}

model CustomSurvey {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  questions   Json // Array of question objects
  targetType  String   @map("target_type") // all, plan, segment
  targetIds   String[] @default([]) @map("target_ids")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  responses SurveyResponse[]

  @@index([isActive])
  @@map("custom_surveys")
}

model SurveyResponse {
  id        String       @id @default(cuid())
  surveyId  String       @map("survey_id")
  survey    CustomSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  shopId    String?      @map("shop_id")
  userId    String?      @map("user_id")
  answers   Json // Answers to questions
  createdAt DateTime     @default(now()) @map("created_at")

  @@index([surveyId])
  @@index([shopId])
  @@map("survey_responses")
}

model Feedback {
  id         String    @id @default(cuid())
  shopId     String?   @map("shop_id")
  userId     String?   @map("user_id")
  type       String // bug, feature, question, complaint
  subject    String
  content    String    @db.Text
  category   String?
  tags       String[]  @default([])
  status     String    @default("new") // new, reviewed, resolved
  reviewedBy String?   @map("reviewed_by")
  reviewedAt DateTime? @map("reviewed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@index([shopId])
  @@index([status])
  @@index([type])
  @@map("feedback")
}

model Translation {
  id         String   @id @default(cuid())
  key        String // Translation key (e.g., "common.save")
  language   String // Language code (e.g., "en", "es", "fr")
  value      String   @db.Text
  context    String? // Where it's used
  isComplete Boolean  @default(true) @map("is_complete")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([key, language])
  @@index([language])
  @@index([isComplete])
  @@map("translations")
}

model ImportJob {
  id          String    @id @default(cuid())
  type        String // shops, users, tickets
  status      String    @default("pending") // pending, processing, completed, failed
  fileUrl     String?   @map("file_url")
  mapping     Json? // Field mapping
  results     Json? // Success/failure counts
  error       String?   @db.Text
  createdById String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@index([status])
  @@index([createdById])
  @@map("import_jobs")
}

model ExportJob {
  id          String    @id @default(cuid())
  type        String // shops, users, transactions
  format      String    @default("csv") // csv, json, xlsx
  filters     Json? // Export filters
  status      String    @default("pending") // pending, generating, completed, failed
  fileUrl     String?   @map("file_url")
  expiresAt   DateTime? @map("expires_at")
  createdById String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@index([status])
  @@index([createdById])
  @@map("export_jobs")
}
