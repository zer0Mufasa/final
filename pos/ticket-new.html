<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Ticket | Fixology POS</title>
  <base href="/pos/">
  <link rel="icon" type="image/webp" href="https://i.ibb.co/GfPnk0zV/preview.webp">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
/* ============================================
   FIXOLOGY POS - DARK THEME DESIGN SYSTEM
   Matching Inventory Page Aesthetic
   ============================================ */

/* CSS Variables - DARK THEME */
:root {
  /* Brand Colors */
  --primary: #8b5cf6;
  --primary-dark: #7c3aed;
  --primary-light: #a78bfa;
  --secondary: rgba(139, 92, 246, 0.15);
  --accent: #7C3AED;
  --purple-glow: rgba(139, 92, 246, 0.3);
  
  /* Status Gradients */
  --status-new: linear-gradient(180deg, #3B82F6, #1D4ED8);
  --status-diagnosed: linear-gradient(180deg, #8B5CF6, #5D3FD3);
  --status-waiting: linear-gradient(180deg, #F59E0B, #D97706);
  --status-repair: linear-gradient(180deg, #6366F1, #4338CA);
  --status-ready: linear-gradient(180deg, #10B981, #047857);
  --status-picked: linear-gradient(180deg, #6B7280, #374151);
  --status-cancelled: linear-gradient(180deg, #EF4444, #B91C1C);
  
  /* Semantic Colors */
  --success: #10B981;
  --success-light: rgba(16, 185, 129, 0.15);
  --warning: #F59E0B;
  --warning-light: rgba(245, 158, 11, 0.15);
  --danger: #EF4444;
  --danger-light: rgba(239, 68, 68, 0.15);
  --info: #3B82F6;
  --info-light: rgba(59, 130, 246, 0.15);
  
  /* Backgrounds - DARK */
  --bg-body: #08080c;
  --bg-card: linear-gradient(165deg, #12121a 0%, #0a0a0f 100%);
  --bg-card-solid: #12121a;
  --bg-sidebar: #0c0c12;
  --bg-sidebar-hover: rgba(139, 92, 246, 0.1);
  --bg-input: rgba(255, 255, 255, 0.04);
  
  /* Text - DARK THEME */
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.6);
  --text-muted: rgba(255, 255, 255, 0.35);
  --text-inverse: #08080c;
  
  /* Borders - DARK */
  --border-color: rgba(255, 255, 255, 0.06);
  --border-focus: #8b5cf6;
  --border-accent: rgba(139, 92, 246, 0.3);
  
  /* Shadows - DARK */
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 8px 20px rgba(0,0,0,0.4);
  --shadow-lg: 0 20px 50px rgba(0,0,0,0.5);
  --shadow-card: 0 4px 20px rgba(0,0,0,0.3);
  --shadow-card-hover: 0 12px 40px rgba(0,0,0,0.4), 0 0 40px var(--purple-glow);
  --shadow-glow: 0 0 40px var(--purple-glow);
  
  /* Spacing */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-8: 32px;
  --space-10: 40px;
  
  /* Border Radius */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-full: 9999px;
  
  /* Transitions */
  --transition-fast: 0.2s ease;
  --transition-normal: 0.3s ease;
  --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* Z-index */
  --z-dropdown: 100;
  --z-modal: 200;
  --z-toast: 300;
  
  /* Fonts */
  --font-sans: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
}

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-sans);
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary);
  background: #08080c;
  -webkit-font-smoothing: antialiased;
}

a {
  color: var(--primary-light);
  text-decoration: none;
}

a:hover {
  color: var(--text-primary);
}

button {
  font-family: inherit;
  cursor: pointer;
}

input, select, textarea {
  font-family: inherit;
  font-size: inherit;
}

/* ============================================
   LAYOUT
   ============================================ */
.pos-app {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Sidebar - Dark Theme */
.pos-sidebar {
  width: 240px;
  background: linear-gradient(180deg, #0c0c12 0%, #08080c 100%);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  transition: width var(--transition-normal);
  border-right: 1px solid var(--border-color);
  position: relative;
}

.pos-sidebar::after {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 1px;
  height: 100%;
  background: linear-gradient(180deg, transparent, var(--primary), transparent);
  opacity: 0.3;
}

.pos-sidebar.collapsed {
  width: 72px;
}

.sidebar-header {
  padding: var(--space-5);
  border-bottom: 1px solid var(--border-color);
}

.sidebar-logo {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  text-decoration: none;
}

.sidebar-logo img {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  box-shadow: 0 4px 20px var(--purple-glow);
}

.sidebar-logo span {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, #fff 0%, var(--primary-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.pos-sidebar.collapsed .sidebar-logo span {
  display: none;
}

.sidebar-nav {
  flex: 1;
  padding: var(--space-4) var(--space-3);
  overflow-y: auto;
  scrollbar-width: none;
}

.sidebar-nav::-webkit-scrollbar {
  display: none;
}

.nav-section {
  margin-bottom: var(--space-6);
}

.nav-section-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: rgba(255,255,255,0.4);
  padding: 0 var(--space-3);
  margin-bottom: var(--space-2);
}

.pos-sidebar.collapsed .nav-section-title {
  display: none;
}

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-3);
  border-radius: var(--radius-md);
  color: rgba(255,255,255,0.7);
  font-size: 14px;
  font-weight: 500;
  transition: all var(--transition-fast);
  text-decoration: none;
  margin-bottom: 2px;
}

.nav-link:hover {
  background: var(--bg-sidebar-hover);
  color: white;
  text-decoration: none;
}

.nav-link.active {
  background: linear-gradient(135deg, rgba(93,63,211,0.3), rgba(124,58,237,0.2));
  color: white;
}

.nav-link .icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.nav-link .badge {
  margin-left: auto;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: 600;
  background: var(--primary);
  color: white;
  border-radius: var(--radius-full);
}

.pos-sidebar.collapsed .nav-link span:not(.icon):not(.badge) {
  display: none;
}

.pos-sidebar.collapsed .nav-link .badge {
  display: none;
}

.sidebar-footer {
  padding: var(--space-4);
  border-top: 1px solid rgba(255,255,255,0.08);
}

.sidebar-user {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.05);
}

.sidebar-user .avatar {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-md);
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: white;
}

.sidebar-user .info {
  flex: 1;
  min-width: 0;
}

.sidebar-user .name {
  font-size: 13px;
  font-weight: 600;
  color: white;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sidebar-user .role {
  font-size: 11px;
  color: rgba(255,255,255,0.5);
}

.pos-sidebar.collapsed .sidebar-user .info {
  display: none;
}

/* Main Content */
.pos-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header - Dark Theme */
.pos-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-4) var(--space-6);
  background: rgba(8, 8, 12, 0.95);
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
  backdrop-filter: blur(20px);
  position: relative;
}

.pos-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--purple-glow), transparent);
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--space-5);
}

.header-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.header-title .count {
  font-size: 13px;
  font-weight: 600;
  padding: 4px 12px;
  background: var(--secondary);
  color: var(--primary-light);
  border-radius: var(--radius-full);
}

.header-right {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

/* Content Area - Dark */
.pos-content {
  flex: 1;
  overflow: auto;
  padding: var(--space-6);
  background: #08080c;
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-fast);
  text-decoration: none;
  white-space: nowrap;
}

.btn:hover {
  transform: translateY(-1px);
  text-decoration: none;
}

.btn:active {
  transform: translateY(0);
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 20px var(--purple-glow);
}

.btn-primary:hover {
  box-shadow: 0 8px 30px var(--purple-glow);
  transform: translateY(-2px);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--border-accent);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #047857);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #B91C1C);
  color: white;
}

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 8px 12px;
}

.btn-ghost:hover {
  background: rgba(255, 255, 255, 0.05);
  color: var(--text-primary);
  transform: none;
}

/* AI Hints Box */
.ai-hints {
  background: rgba(139, 92, 246, 0.08);
  border: 1px solid var(--border-accent);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-5);
}

.ai-hints h4 {
  color: var(--primary-light);
  font-size: 13px;
  margin-bottom: var(--space-3);
}

.ai-chip {
  display: inline-block;
  padding: 6px 12px;
  margin: 4px;
  background: rgba(139, 92, 246, 0.15);
  border: 1px solid var(--border-accent);
  border-radius: var(--radius-full);
  font-size: 12px;
  color: var(--primary-light);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.ai-chip:hover, .ai-chip.active {
  background: var(--primary);
  color: white;
}

.checklist-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: var(--space-2);
}

.btn-icon {
  width: 38px;
  height: 38px;
  padding: 0;
  border-radius: var(--radius-md);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.btn-lg {
  padding: 14px 24px;
  font-size: 16px;
}

/* ============================================
   INPUTS
   ============================================ */
.form-group {
  margin-bottom: var(--space-5);
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: var(--space-2);
}

.form-input {
  width: 100%;
  padding: 14px 16px;
  font-size: 14px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  background: rgba(255, 255, 255, 0.04);
  color: var(--text-primary);
  transition: all var(--transition-fast);
  font-family: inherit;
}

.form-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15), 0 0 30px var(--purple-glow);
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  cursor: pointer;
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.search-box {
  position: relative;
}

.search-box .icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

.search-box input {
  padding-left: 42px;
}

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-card);
  transition: all var(--transition-normal);
}

.card:hover {
  box-shadow: var(--shadow-card-hover);
}

.card-header {
  padding: var(--space-5);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.card-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}

.card-body {
  padding: var(--space-5);
}

.card-footer {
  padding: var(--space-4) var(--space-5);
  border-top: 1px solid var(--border-color);
  background: var(--bg-input);
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
}

/* ============================================
   TICKET CARDS (UNIQUE LEFT BORDER STYLE)
   ============================================ */
.ticket-card {
  position: relative;
  background: white;
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-3);
  cursor: pointer;
  transition: all var(--transition-normal);
  border: 1px solid var(--border-color);
  overflow: hidden;
}

/* LEFT border indicator - UNIQUE to Fixology */
.ticket-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  border-radius: var(--radius-lg) 0 0 var(--radius-lg);
}

.ticket-card.status-new::before { background: var(--status-new); }
.ticket-card.status-diagnosed::before { background: var(--status-diagnosed); }
.ticket-card.status-waiting::before { background: var(--status-waiting); }
.ticket-card.status-repair::before { background: var(--status-repair); }
.ticket-card.status-ready::before { background: var(--status-ready); }
.ticket-card.status-picked::before { background: var(--status-picked); }
.ticket-card.status-cancelled::before { background: var(--status-cancelled); }

.ticket-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
  border-color: var(--primary);
}

.ticket-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--space-3);
}

.ticket-id {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--primary);
}

.ticket-time {
  font-size: 12px;
  color: var(--text-muted);
}

.ticket-customer {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.ticket-device {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: var(--space-3);
}

.ticket-card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.ticket-issue {
  font-size: 12px;
  color: var(--text-muted);
  padding: 4px 10px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
}

.ticket-price {
  font-family: var(--font-mono);
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}

/* Priority Flag */
.priority-flag {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.priority-flag.urgent { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
.priority-flag.high { background: var(--warning); }
.priority-flag.normal { background: var(--success); }
.priority-flag.low { background: var(--text-muted); }

/* Progress Dots */
.progress-dots {
  display: flex;
  gap: 4px;
}

.progress-dots .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--border-color);
}

.progress-dots .dot.active {
  background: var(--primary);
}

.progress-dots .dot.completed {
  background: var(--success);
}

/* ============================================
   STATUS PILLS (GRADIENT)
   ============================================ */
.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  font-size: 12px;
  font-weight: 600;
  border-radius: var(--radius-full);
  color: white;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-pill.new { background: var(--status-new); }
.status-pill.diagnosed { background: var(--status-diagnosed); }
.status-pill.waiting { background: var(--status-waiting); }
.status-pill.repair { background: var(--status-repair); }
.status-pill.ready { background: var(--status-ready); }
.status-pill.picked { background: var(--status-picked); }
.status-pill.cancelled { background: var(--status-cancelled); }

/* ============================================
   KANBAN BOARD
   ============================================ */
.kanban-board {
  display: flex;
  gap: var(--space-5);
  height: 100%;
  overflow-x: auto;
  padding-bottom: var(--space-4);
  cursor: grab;
}

.kanban-board.grabbing {
  cursor: grabbing;
}

.kanban-board::-webkit-scrollbar {
  height: 8px;
}

.kanban-board::-webkit-scrollbar-track {
  background: var(--border-color);
  border-radius: 4px;
}

.kanban-board::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 4px;
}

.kanban-column {
  min-width: 300px;
  width: 300px;
  background: var(--bg-input);
  border-radius: var(--radius-xl);
  display: flex;
  flex-direction: column;
  max-height: 100%;
}

.kanban-column-header {
  padding: var(--space-4);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.kanban-column-icon {
  font-size: 18px;
}

.kanban-column-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  flex: 1;
}

.kanban-column-count {
  font-size: 12px;
  font-weight: 700;
  padding: 4px 10px;
  background: white;
  border-radius: var(--radius-full);
  color: var(--text-secondary);
}

.kanban-column-body {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-3);
  scrollbar-width: none;
}

.kanban-column-body::-webkit-scrollbar {
  display: none;
}

/* Ticket in Kanban */
.kanban-ticket {
  background: white;
  border-radius: var(--radius-md);
  padding: var(--space-3);
  margin-bottom: var(--space-3);
  cursor: pointer;
  transition: all var(--transition-fast);
  border: 1px solid var(--border-color);
  position: relative;
}

.kanban-ticket::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  border-radius: var(--radius-md) 0 0 var(--radius-md);
}

.kanban-ticket.priority-urgent::before { background: var(--danger); }
.kanban-ticket.priority-high::before { background: var(--warning); }
.kanban-ticket.priority-normal::before { background: var(--success); }
.kanban-ticket.priority-low::before { background: var(--text-muted); }

.kanban-ticket:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary);
}

.kanban-ticket-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--space-2);
}

.kanban-ticket-id {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--primary);
}

.kanban-ticket-time {
  font-size: 11px;
  color: var(--text-muted);
}

.kanban-ticket-customer {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 2px;
}

.kanban-ticket-device {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: var(--space-2);
}

.kanban-ticket-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.kanban-ticket-issue {
  font-size: 11px;
  padding: 3px 8px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
}

.kanban-ticket-price {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
}

/* ============================================
   MODALS
   ============================================ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-modal);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-normal);
}

.modal-overlay.open {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: white;
  border-radius: var(--radius-xl);
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
  transform: scale(0.95) translateY(20px);
  transition: transform var(--transition-normal);
}

.modal-overlay.open .modal {
  transform: scale(1) translateY(0);
}

.modal-header {
  padding: var(--space-5) var(--space-6);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
}

.modal-close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--bg-input);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  font-size: 18px;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.modal-close:hover {
  background: var(--danger-light);
  color: var(--danger);
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-6);
}

.modal-footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: var(--space-3);
}

/* ============================================
   TOASTS
   ============================================ */
.toast-container {
  position: fixed;
  top: var(--space-6);
  right: var(--space-6);
  z-index: var(--z-toast);
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
}

.toast {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-4) var(--space-5);
  background: white;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  min-width: 300px;
  max-width: 450px;
  animation: slideIn 0.3s ease;
  border-left: 4px solid;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }

.toast-icon {
  font-size: 20px;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  color: var(--text-primary);
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
}

/* ============================================
   WIZARD STEPS
   ============================================ */
.wizard-steps {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: var(--space-8);
}

.wizard-step {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.wizard-step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bg-input);
  color: var(--text-muted);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.wizard-step.active .wizard-step-number {
  background: var(--primary);
  color: white;
}

.wizard-step.completed .wizard-step-number {
  background: var(--success);
  color: white;
}

.wizard-step-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
}

.wizard-step.active .wizard-step-label {
  color: var(--text-primary);
}

.wizard-step-line {
  width: 60px;
  height: 2px;
  background: var(--border-color);
  margin: 0 var(--space-3);
}

.wizard-step.completed + .wizard-step-line {
  background: var(--success);
}

/* ============================================
   TABLES
   ============================================ */
.table {
  width: 100%;
  border-collapse: collapse;
}

.table th,
.table td {
  padding: var(--space-3) var(--space-4);
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.table th {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: var(--bg-input);
}

.table tr:hover td {
  background: var(--bg-input);
}

/* ============================================
   VIEW TOGGLE
   ============================================ */
.view-toggle {
  display: flex;
  background: var(--bg-input);
  border-radius: var(--radius-md);
  padding: 3px;
}

.view-toggle-btn {
  padding: 8px 14px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.view-toggle-btn.active {
  background: white;
  color: var(--text-primary);
  box-shadow: var(--shadow-sm);
}

/* ============================================
   FILTER TABS
   ============================================ */
.filter-tabs {
  display: flex;
  gap: var(--space-2);
  margin-bottom: var(--space-5);
}

.filter-tab {
  padding: 8px 16px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.filter-tab:hover {
  background: var(--bg-input);
  color: var(--text-primary);
}

.filter-tab.active {
  background: var(--primary);
  color: white;
}

/* ============================================
   DROPDOWN
   ============================================ */
.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: var(--space-2);
  min-width: 180px;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: var(--z-dropdown);
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all var(--transition-fast);
}

.dropdown.open .dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-4);
  font-size: 14px;
  color: var(--text-primary);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.dropdown-item:hover {
  background: var(--bg-input);
}

.dropdown-item.danger {
  color: var(--danger);
}

.dropdown-divider {
  height: 1px;
  background: var(--border-color);
  margin: var(--space-2) 0;
}

/* ============================================
   EMPTY STATE
   ============================================ */
.empty-state {
  text-align: center;
  padding: var(--space-10) var(--space-6);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: var(--space-4);
}

.empty-state-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.empty-state-text {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: var(--space-5);
}

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeIn 0.3s ease;
}

.slide-up {
  animation: slideUp 0.4s ease;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
  .pos-sidebar {
    width: 72px;
  }
  
  .pos-sidebar .nav-link span:not(.icon) {
    display: none;
  }
  
  .sidebar-logo span,
  .nav-section-title,
  .sidebar-user .info {
    display: none;
  }
}

@media (max-width: 768px) {
  .pos-sidebar {
    display: none;
  }
  
  .pos-header {
    padding: var(--space-3) var(--space-4);
  }
  
  .pos-content {
    padding: var(--space-4);
  }
  
  .kanban-column {
    min-width: 280px;
    width: 280px;
  }
}

    .wizard-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .wizard-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .wizard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
    }
    
    .wizard-header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: var(--space-6);
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .wizard-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }
    
    .wizard-header h1 {
      font-size: 24px;
      margin-bottom: var(--space-2);
      position: relative;
    }
    
    .wizard-header p {
      opacity: 0.8;
      position: relative;
    }
    
    .wizard-steps-nav {
      display: flex;
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .step-nav-item {
      flex: 1;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .step-nav-item.active {
      background: rgba(139, 92, 246, 0.15);
      box-shadow: 0 0 20px var(--purple-glow);
    }
    
    .step-nav-item.completed .step-num {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 50%, #16a34a 100%);
    }
    
    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      transition: all var(--transition-normal);
    }
    
    .step-nav-item.active .step-num {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px var(--purple-glow);
    }
    
    .step-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
    }
    
    .step-nav-item.active .step-label {
      color: var(--text-primary);
    }
    
    .wizard-body {
      padding: var(--space-6);
      min-height: 400px;
      background: transparent;
    }
    
    .wizard-body h2, .wizard-body h3 {
      color: var(--text-primary);
    }
    
    .wizard-step {
      display: none;
      animation: fadeInUp 0.4s ease;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .wizard-step.active {
      display: block;
    }
    
    .wizard-footer {
      padding: var(--space-5) var(--space-6);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.02);
    }
    
    /* Customer Search - Dark */
    .customer-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #16161f;
      border: 1px solid var(--border-accent);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg), 0 0 30px var(--purple-glow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .customer-search-results.open {
      display: block;
    }
    
    .customer-result {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .customer-result:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .customer-result:last-child {
      border-bottom: none;
    }
    
    .customer-result small {
      color: var(--text-muted);
    }
    
    .selected-customer {
      background: rgba(139, 92, 246, 0.1);
      border: 2px solid var(--primary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .selected-customer .avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 4px 15px var(--purple-glow);
    }
    
    /* Device Type Selector - Dark with Gradients */
    .device-types {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: var(--space-3);
      margin-bottom: var(--space-5);
    }
    
    /* Dark Scrollbars - Global - FORCE DARK */
    * {
      scrollbar-width: thin !important;
      scrollbar-color: #8b5cf6 #0a0a0f !important;
    }
    
    ::-webkit-scrollbar {
      width: 10px !important;
      height: 10px !important;
      background: #0a0a0f !important;
    }
    
    ::-webkit-scrollbar-track {
      background: #0a0a0f !important;
      border-radius: 5px !important;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #8b5cf6, #6d28d9) !important;
      border-radius: 5px !important;
      border: 2px solid #0a0a0f !important;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #a78bfa, #8b5cf6) !important;
    }
    
    ::-webkit-scrollbar-corner {
      background: #0a0a0f !important;
    }
    
    /* Also target specific scrollable elements */
    select, .form-select, .parts-list, .customer-search-results {
      scrollbar-width: thin !important;
      scrollbar-color: #8b5cf6 #0a0a0f !important;
    }
    
    .device-type-btn {
      padding: var(--space-4);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      text-align: center;
      transition: all var(--transition-slow);
      color: var(--text-primary);
    }
    
    .device-type-btn:hover {
      border-color: var(--border-accent);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }
    
    .device-type-btn.active {
      border-color: var(--primary);
      background: rgba(139, 92, 246, 0.15);
      box-shadow: 0 0 30px var(--purple-glow);
    }
    
    .device-type-btn .icon {
      font-size: 32px;
      display: block;
      margin-bottom: var(--space-2);
    }
    
    .device-type-btn .label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .device-type-btn.active .label {
      color: var(--text-primary);
    }
    
    /* Symptom Chips - Dark Glowing */
    .symptom-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
    }
    
    .symptom-chip {
      padding: 10px 18px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-full);
      background: rgba(255, 255, 255, 0.03);
      font-size: 13px;
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--text-secondary);
    }
    
    .symptom-chip:hover {
      border-color: var(--border-accent);
      color: var(--text-primary);
      transform: translateY(-2px);
    }
    
    .symptom-chip.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 15px var(--purple-glow);
    }
    
    /* Checklist - Dark */
    .diagnosis-checklist {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      transition: all var(--transition-fast);
    }
    
    .checklist-item:hover {
      border-color: var(--border-accent);
    }
    
    .checklist-item label {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .checklist-toggles {
      display: flex;
      gap: 4px;
    }
    
    .checklist-toggle {
      width: 30px;
      height: 30px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 14px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      transition: all var(--transition-fast);
    }
    
    .checklist-toggle:hover {
      border-color: var(--border-accent);
    }
    
    .checklist-toggle.active-yes { background: linear-gradient(135deg, #4ade80, #16a34a); color: white; border-color: #22c55e; }
    .checklist-toggle.active-no { background: linear-gradient(135deg, #f87171, #dc2626); color: white; border-color: #ef4444; }
    .checklist-toggle.active-unknown { background: linear-gradient(135deg, #fbbf24, #d97706); color: white; border-color: #f59e0b; }
    
    /* Pricing Summary - Dark Glow */
    .pricing-summary {
      background: rgba(139, 92, 246, 0.08);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      border: 1px solid var(--border-accent);
    }
    
    .pricing-summary h3 {
      color: var(--text-primary);
    }
    
    .pricing-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .pricing-row span:last-child {
      font-family: var(--font-mono);
      color: var(--text-primary);
    }
    
    .pricing-row.total {
      border-top: 2px solid var(--border-accent);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .pricing-row.total span:last-child {
      color: #4ade80;
    }
    
    /* Parts Selector - Dark */
    .parts-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.02);
    }
    
    .part-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      color: var(--text-primary);
      transition: all var(--transition-fast);
    }
    
    .part-item:hover {
      background: rgba(139, 92, 246, 0.08);
    }
    
    .part-item.selected {
      background: rgba(139, 92, 246, 0.15);
      border-left: 3px solid var(--primary);
    }
    
    .part-item:last-child {
      border-bottom: none;
    }
    
    /* Signature Pad - Dark */
    .signature-pad-container {
      border: 2px dashed var(--border-accent);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      text-align: center;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .signature-pad {
      width: 100%;
      height: 150px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: crosshair;
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* Review Summary - Dark Glowing Cards */
    .review-section {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      border: 1px solid var(--border-color);
      transition: all var(--transition-normal);
    }
    
    .review-section:hover {
      border-color: var(--border-accent);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }
    
    .review-section h4 {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--primary-light);
      margin-bottom: var(--space-3);
      letter-spacing: 0.5px;
    }
    
    .review-section p {
      color: var(--text-secondary);
      margin: 4px 0;
    }
    
    .review-section p strong {
      color: var(--text-primary);
    }
    /* OR Divider */
    .or-divider {
      color: var(--text-muted);
      text-align: center;
      margin: var(--space-5) 0;
      position: relative;
    }
    
    .or-divider::before, .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: var(--border-color);
    }
    
    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }
    
    /* Checkbox Dark */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    /* IMEI Result Box */
    #imei-result {
      background: rgba(16, 185, 129, 0.1) !important;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    #imei-result p {
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <div class="pos-app">
    <!-- Sidebar -->
    <aside class="pos-sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">
          <img src="https://i.ibb.co/GfPnk0zV/preview.webp" alt="Fixology">
          <span>Fixology</span>
        </a>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <a href="index.html" class="nav-link"><span class="icon">üìä</span><span>Dashboard</span></a>
          <a href="tickets.html" class="nav-link"><span class="icon">üé´</span><span>Tickets</span></a>
          <a href="customers.html" class="nav-link"><span class="icon">üë•</span><span>Customers</span></a>
          <a href="inventory.html" class="nav-link"><span class="icon">üì¶</span><span>Inventory</span></a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="pos-main">
      <header class="pos-header">
        <div class="header-left">
          <a href="tickets.html" class="btn btn-ghost">‚Üê Back</a>
        </div>
      </header>

      <div class="pos-content">
        <div class="wizard-container">
          <div class="wizard-card">
            <div class="wizard-header">
              <h1>üé´ New Repair Ticket</h1>
              <p>Create a new repair ticket for your customer</p>
            </div>

            <div class="wizard-steps-nav">
              <div class="step-nav-item active" data-step="1">
                <span class="step-num">1</span>
                <span class="step-label">Customer</span>
              </div>
              <div class="step-nav-item" data-step="2">
                <span class="step-num">2</span>
                <span class="step-label">Device</span>
              </div>
              <div class="step-nav-item" data-step="3">
                <span class="step-num">3</span>
                <span class="step-label">Issue</span>
              </div>
              <div class="step-nav-item" data-step="4">
                <span class="step-num">4</span>
                <span class="step-label">Pricing</span>
              </div>
              <div class="step-nav-item" data-step="5">
                <span class="step-num">5</span>
                <span class="step-label">Review</span>
              </div>
            </div>

            <div class="wizard-body">
              <!-- Step 1: Customer -->
              <div class="wizard-step active" data-step="1">
                <h2 style="margin-bottom: var(--space-5);">Customer Information</h2>
                
                <div id="customer-search-container" style="position: relative; margin-bottom: var(--space-5);">
                  <label class="form-label">Search Existing Customer</label>
                  <input type="text" class="form-input" id="customer-search" placeholder="Search by name, phone, or email...">
                  <div class="customer-search-results" id="customer-results"></div>
                </div>

                <div id="selected-customer-display" style="display: none; margin-bottom: var(--space-5);"></div>

                <div style="text-align: center; margin-bottom: var(--space-5);">
                  <span style="color: var(--text-muted);">‚Äî OR ‚Äî</span>
                </div>

                <h3 style="margin-bottom: var(--space-4);">Add New Customer</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                  <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="customer-name" placeholder="John Smith">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Phone *</label>
                    <input type="tel" class="form-input" id="customer-phone" placeholder="314-555-1234">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="customer-email" placeholder="john@email.com">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="customer-address" placeholder="123 Main St, City, ST 12345">
                  </div>
                </div>
              </div>

              <!-- Step 2: Device -->
              <div class="wizard-step" data-step="2">
                <h2 style="margin-bottom: var(--space-5);">Device Information</h2>
                
                <label class="form-label">Device Type</label>
                <div class="device-types">
                  <button type="button" class="device-type-btn active" data-type="smartphone">
                    <span class="icon">üì±</span>
                    <span class="label">Phone</span>
                  </button>
                  <button type="button" class="device-type-btn" data-type="tablet">
                    <span class="icon">üì±</span>
                    <span class="label">Tablet</span>
                  </button>
                  <button type="button" class="device-type-btn" data-type="laptop">
                    <span class="icon">üíª</span>
                    <span class="label">Laptop</span>
                  </button>
                  <button type="button" class="device-type-btn" data-type="desktop">
                    <span class="icon">üñ•Ô∏è</span>
                    <span class="label">Desktop</span>
                  </button>
                  <button type="button" class="device-type-btn" data-type="console">
                    <span class="icon">üéÆ</span>
                    <span class="label">Console</span>
                  </button>
                  <button type="button" class="device-type-btn" data-type="other">
                    <span class="icon">üìü</span>
                    <span class="label">Other</span>
                  </button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                  <div class="form-group">
                    <label class="form-label">Brand *</label>
                    <select class="form-input form-select" id="device-brand">
                      <option value="">Select Brand</option>
                      <option value="Apple">Apple</option>
                      <option value="Samsung">Samsung</option>
                      <option value="Google">Google</option>
                      <option value="OnePlus">OnePlus</option>
                      <option value="Motorola">Motorola</option>
                      <option value="LG">LG</option>
                      <option value="Sony">Sony</option>
                      <option value="Microsoft">Microsoft</option>
                      <option value="Dell">Dell</option>
                      <option value="HP">HP</option>
                      <option value="Lenovo">Lenovo</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Model *</label>
                    <input type="text" class="form-input" id="device-model" placeholder="iPhone 14 Pro Max">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-input" id="device-color" placeholder="Space Black">
                  </div>
                  <div class="form-group">
                    <label class="form-label">IMEI / Serial</label>
                    <div style="display: flex; gap: var(--space-2);">
                      <input type="text" class="form-input" id="device-imei" placeholder="356558088449233" style="flex: 1;">
                      <button type="button" class="btn btn-secondary" id="check-imei-btn">Check</button>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Passcode</label>
                    <input type="text" class="form-input" id="device-passcode" placeholder="1234 or pattern">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Condition</label>
                    <select class="form-input form-select" id="device-condition">
                      <option value="Excellent">Excellent</option>
                      <option value="Good" selected>Good</option>
                      <option value="Fair">Fair</option>
                      <option value="Poor">Poor</option>
                    </select>
                  </div>
                </div>

                <div id="imei-result" style="display: none; margin-top: var(--space-4); padding: var(--space-4); background: var(--success-light); border-radius: var(--radius-md);"></div>
              </div>

              <!-- Step 3: Issue -->
              <div class="wizard-step" data-step="3">
                <h2 style="margin-bottom: var(--space-5);">Issue & Diagnosis</h2>

                <div class="form-group">
                  <label class="form-label">Customer's Description *</label>
                  <textarea class="form-input form-textarea" id="issue-description" placeholder="Describe the problem in the customer's words..."></textarea>
                </div>
                <div class="ai-hints" id="ai-hints" style="display:none;">
                  <h4>Suggested symptoms & checks</h4>
                  <div class="ai-suggestions" id="ai-suggested-symptoms"></div>
                  <div class="checklist-hint" id="ai-checklist-hints"></div>
                </div>

                <label class="form-label">Common Symptoms (click to select)</label>
                <div class="symptom-chips" id="symptom-chips">
                  <button type="button" class="symptom-chip" data-symptom="cracked_screen">üî≤ Cracked Screen</button>
                  <button type="button" class="symptom-chip" data-symptom="no_power">‚ö° Won't Power On</button>
                  <button type="button" class="symptom-chip" data-symptom="no_charge">üîå Won't Charge</button>
                  <button type="button" class="symptom-chip" data-symptom="battery_drain">üîã Battery Drains Fast</button>
                  <button type="button" class="symptom-chip" data-symptom="water_damage">üíß Water Damage</button>
                  <button type="button" class="symptom-chip" data-symptom="no_touch">üëÜ Touch Not Working</button>
                  <button type="button" class="symptom-chip" data-symptom="no_display">üñ•Ô∏è Display Issues</button>
                  <button type="button" class="symptom-chip" data-symptom="speaker">üîä Speaker Issues</button>
                  <button type="button" class="symptom-chip" data-symptom="microphone">üé§ Microphone Issues</button>
                  <button type="button" class="symptom-chip" data-symptom="camera">üì∑ Camera Issues</button>
                  <button type="button" class="symptom-chip" data-symptom="buttons">üîò Button Issues</button>
                  <button type="button" class="symptom-chip" data-symptom="software">üì± Software Issues</button>
                </div>

                <label class="form-label" style="margin-top: var(--space-5);">Diagnostic Checklist</label>
                <div class="diagnosis-checklist" id="checklist">
                  <div class="checklist-item" data-check="powersOn">
                    <label>Powers On</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                  <div class="checklist-item" data-check="touchWorks">
                    <label>Touch Works</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                  <div class="checklist-item" data-check="soundWorks">
                    <label>Sound Works</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                  <div class="checklist-item" data-check="chargingWorks">
                    <label>Charging Works</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                  <div class="checklist-item" data-check="cameraWorks">
                    <label>Camera Works</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                  <div class="checklist-item" data-check="wifiWorks">
                    <label>WiFi Works</label>
                    <div class="checklist-toggles">
                      <button type="button" class="checklist-toggle" data-value="yes">‚úì</button>
                      <button type="button" class="checklist-toggle" data-value="no">‚úó</button>
                      <button type="button" class="checklist-toggle active-unknown" data-value="unknown">?</button>
                    </div>
                  </div>
                </div>

                <div class="form-group" style="margin-top: var(--space-5);">
                  <label class="form-label">Technician Notes</label>
                  <textarea class="form-input form-textarea" id="tech-notes" placeholder="Internal notes about the diagnosis..."></textarea>
                </div>
              </div>

              <!-- Step 4: Pricing -->
              <div class="wizard-step" data-step="4">
                <h2 style="margin-bottom: var(--space-5);">Pricing & Parts</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
                  <div>
                    <div class="form-group">
                      <label class="form-label">Repair Type</label>
                      <select class="form-input form-select" id="repair-type">
                        <option value="screen_replacement">Screen Replacement</option>
                        <option value="battery_replacement">Battery Replacement</option>
                        <option value="charging_port">Charging Port Repair</option>
                        <option value="back_glass">Back Glass Replacement</option>
                        <option value="camera_repair">Camera Repair</option>
                        <option value="speaker_repair">Speaker Repair</option>
                        <option value="button_repair">Button Repair</option>
                        <option value="water_damage">Water Damage Treatment</option>
                        <option value="software">Software Repair</option>
                        <option value="diagnostic">Diagnostic Only</option>
                        <option value="other">Other</option>
                      </select>
                    </div>

                    <label class="form-label">Select Parts</label>
                    <div class="parts-list" id="parts-list">
                      <!-- Parts will be loaded from inventory -->
                    </div>

                    <div style="margin-top: var(--space-4); display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                      <div class="form-group">
                        <label class="form-label">Labor Cost</label>
                        <input type="number" class="form-input" id="labor-cost" value="50" min="0" step="5">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Discount</label>
                        <input type="number" class="form-input" id="discount" value="0" min="0">
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Estimated Time (minutes)</label>
                      <input type="number" class="form-input" id="est-time" value="30" min="5" step="5">
                    </div>

                    <div class="form-group">
                      <label class="form-label">Deposit Required</label>
                      <input type="number" class="form-input" id="deposit" value="0" min="0">
                    </div>
                  </div>

                  <div>
                    <div class="pricing-summary" id="pricing-summary">
                      <h3 style="margin-bottom: var(--space-4);">üí∞ Pricing Summary</h3>
                      <div class="pricing-row">
                        <span>Parts</span>
                        <span id="summary-parts">$0.00</span>
                      </div>
                      <div class="pricing-row">
                        <span>Labor</span>
                        <span id="summary-labor">$50.00</span>
                      </div>
                      <div class="pricing-row">
                        <span>Discount</span>
                        <span id="summary-discount">-$0.00</span>
                      </div>
                      <div class="pricing-row">
                        <span>Subtotal</span>
                        <span id="summary-subtotal">$50.00</span>
                      </div>
                      <div class="pricing-row">
                        <span>Tax (8%)</span>
                        <span id="summary-tax">$4.00</span>
                      </div>
                      <div class="pricing-row total">
                        <span>Total</span>
                        <span id="summary-total">$54.00</span>
                      </div>
                      <div class="pricing-row" style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px dashed var(--border-color);">
                        <span>Deposit</span>
                        <span id="summary-deposit">$0.00</span>
                      </div>
                      <div class="pricing-row" style="font-weight: 600; color: var(--primary);">
                        <span>Balance Due</span>
                        <span id="summary-balance">$54.00</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 5: Review -->
              <div class="wizard-step" data-step="5">
                <h2 style="margin-bottom: var(--space-5);">Review & Submit</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                  <div class="review-section">
                    <h4>üë§ Customer</h4>
                    <div id="review-customer"></div>
                  </div>
                  <div class="review-section">
                    <h4>üì± Device</h4>
                    <div id="review-device"></div>
                  </div>
                  <div class="review-section">
                    <h4>üîß Issue</h4>
                    <div id="review-issue"></div>
                  </div>
                  <div class="review-section">
                    <h4>üí∞ Pricing</h4>
                    <div id="review-pricing"></div>
                  </div>
                </div>

                <div style="margin-top: var(--space-5);">
                  <label class="form-label">Customer Signature</label>
                  <div class="signature-pad-container">
                    <canvas id="signature-pad" class="signature-pad"></canvas>
                    <div style="margin-top: var(--space-3);">
                      <button type="button" class="btn btn-secondary btn-sm" id="clear-signature">Clear</button>
                    </div>
                  </div>
                </div>

                <div style="margin-top: var(--space-4);">
                  <label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
                    <input type="checkbox" id="terms-agree">
                    <span>Customer agrees to repair terms and conditions</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="wizard-footer">
              <button type="button" class="btn btn-secondary" id="prev-btn" style="visibility: hidden;">‚Üê Previous</button>
              <div>
                <button type="button" class="btn btn-secondary" id="save-draft-btn">Save Draft</button>
                <button type="button" class="btn btn-primary" id="next-btn">Next ‚Üí</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/pos-data.js"></script>
  <script src="js/pos-core.js"></script>
  <script>
    // Ticket data being built
    let ticketData = {
      customer: null,
      device: { type: 'smartphone' },
      issue: { symptoms: [], checklist: {} },
      repair: { notes: [] },
      parts: [],
      pricing: { laborCost: 50, partsCost: 0, discount: 0, taxRate: 0.08, deposit: 0 }
    };

  const aiSymptomMap = [
    { id: 'cracked_screen', label: 'Cracked Screen', keywords: ['crack', 'glass', 'broken screen', 'shatter'] },
    { id: 'no_power', label: 'Won‚Äôt Power On', keywords: ['no power', 'dead', 'won\'t turn on'] },
    { id: 'no_charge', label: 'Charging Issue', keywords: ['charge', 'charging', 'not charging', 'port'] },
    { id: 'battery_drain', label: 'Battery Drain', keywords: ['battery', 'drain', 'dies fast', 'low battery'] },
    { id: 'water_damage', label: 'Water Damage', keywords: ['water', 'liquid', 'spill'] },
    { id: 'no_touch', label: 'Touch Not Working', keywords: ['touch', 'digitizer', 'unresponsive'] },
    { id: 'no_display', label: 'Display Issue', keywords: ['display', 'screen black', 'no image'] },
    { id: 'speaker', label: 'Speaker Issue', keywords: ['speaker', 'sound', 'quiet'] },
    { id: 'microphone', label: 'Microphone Issue', keywords: ['microphone', 'mic', 'caller cannot hear'] },
    { id: 'camera', label: 'Camera Issue', keywords: ['camera', 'lens', 'photo', 'video'] },
    { id: 'buttons', label: 'Button Issue', keywords: ['button', 'volume', 'power button'] },
    { id: 'software', label: 'Software Issue', keywords: ['os', 'software', 'slow', 'lag', 'update'] }
  ];

  const aiChecklistMap = [
    { check: 'touchWorks', value: 'no', keywords: ['no touch', 'touch', 'digitizer'] },
    { check: 'powersOn', value: 'no', keywords: ['no power', 'dead', 'won\'t turn on'] },
    { check: 'chargingWorks', value: 'no', keywords: ['charge', 'charging', 'port'] },
    { check: 'cameraWorks', value: 'no', keywords: ['camera'] },
    { check: 'soundWorks', value: 'no', keywords: ['speaker', 'sound'] },
    { check: 'wifiWorks', value: 'no', keywords: ['wifi', 'wi-fi', 'network'] }
  ];

  const aiRepairSuggestions = [
    { type: 'screen_replacement', keywords: ['screen', 'glass', 'display', 'digitizer'] },
    { type: 'battery_replacement', keywords: ['battery', 'dies', 'drain'] },
    { type: 'charging_port', keywords: ['charge', 'charging', 'port'] },
    { type: 'water_damage', keywords: ['water', 'liquid'] },
    { type: 'software', keywords: ['software', 'slow', 'lag'] }
  ];

    let currentStep = 1;
    const totalSteps = 5;
    let selectedParts = [];
  let autoParts = new Set();
  let repairManuallySelected = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupCustomerSearch();
      setupDeviceTypes();
      setupSymptomChips();
      setupChecklist();
      loadPartsInventory();
      setupPricingListeners();
      setupSignaturePad();
      setupNavigation();
      setupDescriptionAI();
      setupModelIntelligence();
      updatePricingSummary();
      
      // Check for prefill customer from customers page
      const prefillCustomerId = sessionStorage.getItem('prefill_customer');
      if (prefillCustomerId) {
        selectCustomer(prefillCustomerId);
        sessionStorage.removeItem('prefill_customer');
      }
    });

    // Navigation
    function setupNavigation() {
      document.getElementById('next-btn').addEventListener('click', () => {
        if (validateStep(currentStep)) {
          if (currentStep < totalSteps) {
            goToStep(currentStep + 1);
          } else {
            submitTicket();
          }
        }
      });

      document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentStep > 1) {
          goToStep(currentStep - 1);
        }
      });

      document.querySelectorAll('.step-nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const step = parseInt(item.dataset.step);
          if (step < currentStep || validateStep(currentStep)) {
            goToStep(step);
          }
        });
      });
    }

    function goToStep(step) {
      // Mark previous steps as completed
      for (let i = 1; i < step; i++) {
        document.querySelector(`.step-nav-item[data-step="${i}"]`).classList.add('completed');
      }

      // Update current step
      currentStep = step;

      // Update nav
      document.querySelectorAll('.step-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`.step-nav-item[data-step="${step}"]`).classList.add('active');

      // Show step content
      document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.wizard-step[data-step="${step}"]`).classList.add('active');

      // Update buttons
      document.getElementById('prev-btn').style.visibility = step === 1 ? 'hidden' : 'visible';
      document.getElementById('next-btn').textContent = step === totalSteps ? '‚úì Create Ticket' : 'Next ‚Üí';

      // Update review if on last step
      if (step === 5) {
        updateReview();
      }
    }

    function validateStep(step) {
      if (step === 1) {
        const name = document.getElementById('customer-name').value;
        const phone = document.getElementById('customer-phone').value;
        if (!ticketData.customer && (!name || !phone)) {
          POS.error('Please enter customer name and phone');
          return false;
        }
        if (!ticketData.customer) {
          ticketData.customer = {
            id: 'CUST-' + Date.now(),
            name: name,
            phone: phone,
            email: document.getElementById('customer-email').value,
            address: document.getElementById('customer-address').value
          };
        }
      }
      if (step === 2) {
        const brand = document.getElementById('device-brand').value;
        const model = document.getElementById('device-model').value;
        if (!brand || !model) {
          POS.error('Please enter device brand and model');
          return false;
        }
        ticketData.device.brand = brand;
        ticketData.device.model = model;
        ticketData.device.color = document.getElementById('device-color').value;
        ticketData.device.imei = document.getElementById('device-imei').value;
        ticketData.device.passcode = document.getElementById('device-passcode').value;
        ticketData.device.condition = document.getElementById('device-condition').value;
      }
      if (step === 3) {
        const description = document.getElementById('issue-description').value;
        if (!description) {
          POS.error('Please enter the customer\'s issue description');
          return false;
        }
        ticketData.issue.customerDescription = description;
        ticketData.issue.techNotes = document.getElementById('tech-notes').value;
      }
      if (step === 4) {
        ticketData.repair.type = document.getElementById('repair-type').value;
        ticketData.repair.estimatedTime = parseInt(document.getElementById('est-time').value);
        ticketData.parts = selectedParts;
        ticketData.pricing.laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
        ticketData.pricing.discount = parseFloat(document.getElementById('discount').value) || 0;
        ticketData.pricing.deposit = parseFloat(document.getElementById('deposit').value) || 0;
        calculateTotal();
      }
      return true;
    }

    // Customer Search
    function setupCustomerSearch() {
      const searchInput = document.getElementById('customer-search');
      const resultsDiv = document.getElementById('customer-results');

      searchInput.addEventListener('input', POS.debounce((e) => {
        const query = e.target.value;
        if (query.length < 2) {
          resultsDiv.classList.remove('open');
          return;
        }

        const customers = POS_DATA.searchCustomers(query);
        if (customers.length === 0) {
          resultsDiv.innerHTML = '<div class="customer-result">No customers found</div>';
        } else {
          resultsDiv.innerHTML = customers.map(c => `
            <div class="customer-result" data-id="${c.id}">
              <strong>${c.name}</strong><br>
              <small>${c.phone} ‚Ä¢ ${c.email || 'No email'}</small>
            </div>
          `).join('');
        }
        resultsDiv.classList.add('open');
      }, 200));

      resultsDiv.addEventListener('click', (e) => {
        const result = e.target.closest('.customer-result');
        if (result && result.dataset.id) {
          selectCustomer(result.dataset.id);
          resultsDiv.classList.remove('open');
          searchInput.value = '';
        }
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#customer-search-container')) {
          resultsDiv.classList.remove('open');
        }
      });
    }

    function selectCustomer(customerId) {
      const customer = POS_DATA.getCustomer(customerId);
      if (customer) {
        ticketData.customer = customer;
        document.getElementById('selected-customer-display').style.display = 'block';
        document.getElementById('selected-customer-display').innerHTML = `
          <div class="selected-customer">
            <div class="avatar">${customer.name.charAt(0)}</div>
            <div>
              <strong>${customer.name}</strong><br>
              <small>${customer.phone} ‚Ä¢ ${customer.email || 'No email'}</small>
            </div>
            <button type="button" class="btn btn-ghost" onclick="clearSelectedCustomer()">‚úï</button>
          </div>
        `;
        // Clear new customer form
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('customer-email').value = '';
        document.getElementById('customer-address').value = '';
      }
    }

    function clearSelectedCustomer() {
      ticketData.customer = null;
      document.getElementById('selected-customer-display').style.display = 'none';
      document.getElementById('selected-customer-display').innerHTML = '';
    }

    // Device Types
    function setupDeviceTypes() {
      document.querySelectorAll('.device-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.device-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          ticketData.device.type = btn.dataset.type;
        });
      });

      // IMEI Check
      document.getElementById('check-imei-btn').addEventListener('click', async () => {
        const imei = document.getElementById('device-imei').value;
        if (!imei) {
          POS.warning('Please enter an IMEI number');
          return;
        }
        
        const resultDiv = document.getElementById('imei-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<p>Checking IMEI...</p>';
        
        try {
          const response = await fetch('/api/imei-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imei, checkType: 'basic' })
          });
          const data = await response.json();
          
          if (data.valid !== false) {
            resultDiv.innerHTML = `
              <p><strong>‚úÖ IMEI Valid</strong></p>
              <p>Device: ${data.deviceName || 'Unknown'}</p>
              <p>Model: ${data.modelName || 'Unknown'}</p>
            `;
            if (data.modelName) {
              document.getElementById('device-model').value = data.modelName;
            }
          } else {
            resultDiv.style.background = 'var(--danger-light)';
            resultDiv.innerHTML = '<p><strong>‚ùå Invalid IMEI</strong></p>';
          }
        } catch (err) {
          resultDiv.style.background = 'var(--warning-light)';
          resultDiv.innerHTML = '<p>Could not check IMEI. You can continue without verification.</p>';
        }
      });
    }

    // Symptom Chips
    function setupSymptomChips() {
      document.querySelectorAll('.symptom-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          toggleSymptom(chip.dataset.symptom);
        });
      });
    }

    function toggleSymptom(symptomId, forceActive = undefined) {
      const chip = document.querySelector(`.symptom-chip[data-symptom="${symptomId}"]`);
      if (!chip) return;
      const shouldActivate = forceActive !== undefined ? forceActive : !chip.classList.contains('active');
      chip.classList.toggle('active', shouldActivate);
      if (shouldActivate) {
        if (!ticketData.issue.symptoms.includes(symptomId)) {
          ticketData.issue.symptoms.push(symptomId);
        }
      } else {
        ticketData.issue.symptoms = ticketData.issue.symptoms.filter(s => s !== symptomId);
      }
    }

    // Checklist
    function setupChecklist() {
      document.querySelectorAll('.checklist-item').forEach(item => {
        const checkName = item.dataset.check;
        ticketData.issue.checklist[checkName] = 'unknown';

        item.querySelectorAll('.checklist-toggle').forEach(toggle => {
          toggle.addEventListener('click', () => {
            setChecklistValue(checkName, toggle.dataset.value);
          });
        });
      });
    }

    function setChecklistValue(checkName, value) {
      const item = document.querySelector(`.checklist-item[data-check="${checkName}"]`);
      if (!item) return;
      item.querySelectorAll('.checklist-toggle').forEach(t => {
        t.classList.remove('active-yes', 'active-no', 'active-unknown');
      });
      const target = item.querySelector(`.checklist-toggle[data-value="${value}"]`);
      if (target) {
        target.classList.add(`active-${value}`);
      }
      ticketData.issue.checklist[checkName] = value;
    }

    // AI Suggestions from description
    function setupDescriptionAI() {
      const desc = document.getElementById('issue-description');
      if (!desc) return;
      
      // Use native debounce instead of POS.debounce
      let debounceTimer;
      desc.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          updateDescriptionIntelligence();
        }, 300);
      });
      
      // Also trigger on blur for immediate effect
      desc.addEventListener('blur', updateDescriptionIntelligence);
    }

    function updateDescriptionIntelligence() {
      const text = (document.getElementById('issue-description').value || '').toLowerCase();
      const matchedSymptoms = aiSymptomMap
        .filter(s => s.keywords.some(k => text.includes(k)))
        .map(s => s.id);

      const matchedChecks = aiChecklistMap.filter(rule =>
        rule.keywords.some(k => text.includes(k))
      );

      const wrapper = document.getElementById('ai-hints');
      const chipWrap = document.getElementById('ai-suggested-symptoms');
      const checklistHint = document.getElementById('ai-checklist-hints');

      // AUTO-SELECT symptoms as user types (immediate feedback)
      matchedSymptoms.forEach(symptomId => {
        toggleSymptom(symptomId, true);
      });

      // AUTO-SET checklist values based on description
      matchedChecks.forEach(rule => setChecklistValue(rule.check, rule.value));

      if (!matchedSymptoms.length && !matchedChecks.length) {
        wrapper.style.display = 'none';
        chipWrap.innerHTML = '';
        checklistHint.textContent = '';
        return;
      }

      wrapper.style.display = 'block';
      chipWrap.innerHTML = `<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">‚ú® AI detected and auto-selected:</div>` + 
        matchedSymptoms.map(id => {
          const meta = aiSymptomMap.find(s => s.id === id);
          return `<span class="ai-chip active" style="cursor: default;">${meta?.label || id}</span>`;
        }).join('');

      checklistHint.textContent = matchedChecks.length
        ? `‚úì Checklist auto-set: ${matchedChecks.map(c => `${c.check} ‚Üí ${c.value}`).join(', ')}`
        : '';

      // Suggest repair type if user hasn't chosen
      if (!repairManuallySelected) {
        const repairHit = aiRepairSuggestions.find(r => r.keywords.some(k => text.includes(k)));
        if (repairHit) {
          document.getElementById('repair-type').value = repairHit.type;
          ticketData.repair.type = repairHit.type;
        }
      }
    }

    // Model/brand intelligence -> parts & pricing
    function setupModelIntelligence() {
      const brandInput = document.getElementById('device-brand');
      const modelInput = document.getElementById('device-model');

      [brandInput, modelInput].forEach(input => {
        input.addEventListener('input', POS.debounce(() => {
          applyModelDefaults();
          loadPartsInventory(); // Reload parts filtered by device
        }, 200));
        input.addEventListener('change', POS.debounce(() => {
          applyModelDefaults();
          loadPartsInventory(); // Reload parts filtered by device
        }, 200));
      });

      document.getElementById('repair-type').addEventListener('change', () => {
        repairManuallySelected = true;
      });
    }

    function applyModelDefaults() {
      const brand = (document.getElementById('device-brand').value || '').trim();
      const model = (document.getElementById('device-model').value || '').trim();
      if (!brand && !model) return;

      // Remove previous auto parts
      if (autoParts.size) {
        selectedParts = selectedParts.filter(p => !autoParts.has(p.id));
        autoParts.clear();
      }

      const inventory = POS_DATA.getInventory();
      const normBrand = normalizeText(brand);
      const normModel = normalizeText(model);

      const matches = inventory.filter(part => {
        const name = normalizeText(part.name || '');
        return (normModel && name.includes(normModel)) || (normBrand && name.includes(normBrand));
      });

      matches.slice(0, 2).forEach(part => {
        autoParts.add(part.id);
        if (!selectedParts.find(p => p.id === part.id)) {
          selectedParts.push({ ...part, quantity: 1 });
        }
      });

      if (matches.length) {
        const laborInput = document.getElementById('labor-cost');
        const current = parseFloat(laborInput.value) || 0;
        laborInput.value = Math.max(current, 60);
      }

      syncPartsSelectionUI();
      updatePricingSummary();
    }

    function normalizeText(text) {
      return (text || '').toLowerCase().replace(/[^a-z0-9]/g, ' ').trim();
    }

    function syncPartsSelectionUI() {
      document.querySelectorAll('.part-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const selected = selectedParts.some(p => p.id === item.dataset.id);
        checkbox.checked = selected;
        item.classList.toggle('selected', selected);
      });
    }

    // Parts Inventory - with device model filtering
    function loadPartsInventory() {
      const inventory = POS_DATA.getInventory();
      const partsList = document.getElementById('parts-list');
      
      // Get current device model for filtering
      const deviceModel = (document.getElementById('device-model')?.value || '').toLowerCase();
      const deviceBrand = (document.getElementById('device-brand')?.value || '').toLowerCase();
      
      // Filter parts based on device model/brand
      let filteredInventory = inventory;
      if (deviceModel || deviceBrand) {
        filteredInventory = inventory.filter(part => {
          const partName = (part.name || '').toLowerCase();
          // If we have a model like "iPhone 14 Pro Max", match parts with "14" or "iphone 14"
          const modelMatch = deviceModel && (
            partName.includes(deviceModel) || 
            partName.includes(deviceModel.replace(/\s+/g, '')) ||
            // Match partial model numbers (e.g., "14" matches "iPhone 14 Screen")
            deviceModel.split(' ').some(word => word.length > 1 && partName.includes(word))
          );
          const brandMatch = deviceBrand && partName.includes(deviceBrand);
          return modelMatch || brandMatch;
        });
        
        // If no matches found, show all parts
        if (filteredInventory.length === 0) {
          filteredInventory = inventory;
        }
      }
      
      if (filteredInventory.length === 0) {
        partsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No parts in inventory</div>';
        return;
      }

      partsList.innerHTML = filteredInventory.map(part => `
        <div class="part-item" data-id="${part.id}">
          <input type="checkbox" style="width: 18px; height: 18px; accent-color: var(--primary);">
          <div style="flex: 1;">
            <strong>${part.name}</strong>
            <div style="font-size: 12px; color: var(--text-muted);">Stock: ${part.stock || 0}</div>
          </div>
          <div style="font-family: var(--font-mono); font-weight: 600; color: #4ade80;">$${part.price?.toFixed(2)}</div>
        </div>
      `).join('');

      partsList.querySelectorAll('.part-item').forEach(item => {
        const checkbox = item.querySelector('input');
        const partId = item.dataset.id;
        const alreadySelected = selectedParts.some(p => p.id === partId);
        checkbox.checked = alreadySelected;
        item.classList.toggle('selected', alreadySelected);

        item.addEventListener('click', () => {
          checkbox.checked = !checkbox.checked;
          item.classList.toggle('selected', checkbox.checked);

          if (checkbox.checked) {
            const part = POS_DATA.getPart(partId);
            if (part && !selectedParts.find(p => p.id === partId)) {
              selectedParts.push({ ...part, quantity: 1 });
            }
          } else {
            selectedParts = selectedParts.filter(p => p.id !== partId);
            autoParts.delete(partId);
          }
          updatePricingSummary();
        });
      });
    }

    // Pricing
    function setupPricingListeners() {
      ['labor-cost', 'discount', 'deposit'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePricingSummary);
      });
    }

    function updatePricingSummary() {
      const laborCost = parseFloat(document.getElementById('labor-cost').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const deposit = parseFloat(document.getElementById('deposit').value) || 0;
      const partsCost = selectedParts.reduce((sum, p) => sum + (p.price || 0) * (p.quantity || 1), 0);
      
      const subtotal = laborCost + partsCost - discount;
      const tax = subtotal * 0.08;
      const total = subtotal + tax;
      const balance = total - deposit;

      document.getElementById('summary-parts').textContent = POS.formatCurrency(partsCost);
      document.getElementById('summary-labor').textContent = POS.formatCurrency(laborCost);
      document.getElementById('summary-discount').textContent = '-' + POS.formatCurrency(discount);
      document.getElementById('summary-subtotal').textContent = POS.formatCurrency(subtotal);
      document.getElementById('summary-tax').textContent = POS.formatCurrency(tax);
      document.getElementById('summary-total').textContent = POS.formatCurrency(total);
      document.getElementById('summary-deposit').textContent = POS.formatCurrency(deposit);
      document.getElementById('summary-balance').textContent = POS.formatCurrency(balance);

      ticketData.pricing.partsCost = partsCost;
      ticketData.pricing.tax = tax;
      ticketData.pricing.total = total;
    }

    function calculateTotal() {
      const { laborCost, partsCost, discount, taxRate, deposit } = ticketData.pricing;
      const subtotal = laborCost + partsCost - discount;
      const tax = subtotal * taxRate;
      const total = subtotal + tax;
      
      ticketData.pricing.tax = tax;
      ticketData.pricing.total = total;
      ticketData.pricing.balanceDue = total - deposit;
    }

    // Signature Pad
    function setupSignaturePad() {
      const canvas = document.getElementById('signature-pad');
      const ctx = canvas.getContext('2d');
      let isDrawing = false;

      // Set canvas size
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;

      canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      });

      canvas.addEventListener('mouseup', () => {
        isDrawing = false;
      });

      canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
      });

      // Touch support
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
      });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
        ctx.stroke();
      });

      canvas.addEventListener('touchend', () => {
        isDrawing = false;
      });

      document.getElementById('clear-signature').addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }

    // Review
    function updateReview() {
      document.getElementById('review-customer').innerHTML = `
        <p><strong>${ticketData.customer?.name || 'Unknown'}</strong></p>
        <p>${ticketData.customer?.phone || ''}</p>
        <p>${ticketData.customer?.email || ''}</p>
      `;

      document.getElementById('review-device').innerHTML = `
        <p><strong>${ticketData.device?.brand} ${ticketData.device?.model}</strong></p>
        <p>${ticketData.device?.color || ''} ‚Ä¢ ${ticketData.device?.condition || ''}</p>
        <p>IMEI: ${ticketData.device?.imei || 'N/A'}</p>
      `;

      document.getElementById('review-issue').innerHTML = `
        <p>${ticketData.issue?.customerDescription || ''}</p>
        <p>Repair: ${ticketData.repair?.type?.replace(/_/g, ' ') || ''}</p>
        <p>Est. Time: ${ticketData.repair?.estimatedTime || 30} min</p>
      `;

      document.getElementById('review-pricing').innerHTML = `
        <p>Total: <strong>${POS.formatCurrency(ticketData.pricing?.total)}</strong></p>
        <p>Deposit: ${POS.formatCurrency(ticketData.pricing?.deposit)}</p>
        <p>Balance: <strong>${POS.formatCurrency(ticketData.pricing?.total - ticketData.pricing?.deposit)}</strong></p>
      `;
    }

    // Submit
    function submitTicket() {
      if (!document.getElementById('terms-agree').checked) {
        POS.error('Please confirm customer agrees to terms');
        return;
      }

      // Get signature
      const canvas = document.getElementById('signature-pad');
      ticketData.approval = {
        estimateApproved: true,
        approvedAt: new Date().toISOString(),
        approvalMethod: 'in_person',
        signature: canvas.toDataURL()
      };

      // Set status
      ticketData.status = 'new';
      ticketData.priority = 'normal';

      // Save customer if new
      if (ticketData.customer && !ticketData.customer.id.startsWith('CUST-')) {
        POS_DATA.saveCustomer(ticketData.customer);
      }

      // Save ticket
      const savedTicket = POS_DATA.saveTicket(ticketData);
      POS_DATA.addActivity(savedTicket.id, 'Ticket created', 'System');

      POS.success('Ticket created successfully!');
      
      setTimeout(() => {
        window.location.href = `ticket-view.html?id=${savedTicket.id}`;
      }, 1000);
    }
  </script>
</body>
</html>

