<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tickets | Fixology POS</title>
  <link rel="icon" type="image/webp" href="https://i.ibb.co/GfPnk0zV/preview.webp">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/pos.css" type="text/css">
</head>
<body>
  <div class="pos-app">
    <!-- Sidebar -->
    <aside class="pos-sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">
          <img src="https://i.ibb.co/GfPnk0zV/preview.webp" alt="Fixology">
          <span>Fixology</span>
        </a>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a href="index.html" class="nav-link">
            <span class="icon">üìä</span>
            <span>Dashboard</span>
          </a>
          <a href="tickets.html" class="nav-link active">
            <span class="icon">üé´</span>
            <span>Tickets</span>
            <span class="badge" id="ticket-count">0</span>
          </a>
          <a href="customers.html" class="nav-link">
            <span class="icon">üë•</span>
            <span>Customers</span>
          </a>
          <a href="inventory.html" class="nav-link">
            <span class="icon">üì¶</span>
            <span>Inventory</span>
          </a>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <a href="../dashboard/imei.html" class="nav-link">
            <span class="icon">üì±</span>
            <span>IMEI Check</span>
          </a>
          <a href="../dashboard/diagnostics.html" class="nav-link">
            <span class="icon">üß†</span>
            <span>AI Diagnose</span>
          </a>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <a href="settings.html" class="nav-link">
            <span class="icon">‚öôÔ∏è</span>
            <span>Settings</span>
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="avatar">F</div>
          <div class="info">
            <div class="name">Fixology</div>
            <div class="role">Admin</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="pos-main">
      <!-- Header -->
      <header class="pos-header">
        <div class="header-left">
          <h1 class="header-title">
            üé´ Tickets
            <span class="count" id="header-count">0</span>
          </h1>
          <div class="header-stats" style="display:flex;gap:20px;margin-left:20px;font-size:14px;color:var(--text-secondary)">
            <span><strong id="stat-today">0</strong> today</span>
            <span><strong id="stat-revenue">$0</strong> revenue</span>
          </div>
        </div>
        <div class="header-right">
          <div class="search-box">
            <span class="icon">üîç</span>
            <input type="text" class="form-input" placeholder="Search tickets..." id="search-input">
          </div>
          <div class="view-toggle">
            <button class="view-toggle-btn active" data-view="kanban">Board</button>
            <button class="view-toggle-btn" data-view="list">List</button>
          </div>
          <a href="ticket-new.html" class="btn btn-primary">+ New Ticket</a>
        </div>
      </header>

      <!-- Filter Tabs -->
      <div style="padding: 0 var(--space-6); padding-top: var(--space-4);">
        <div class="filter-tabs" id="filter-tabs">
          <button class="filter-tab active" data-filter="all">All</button>
          <button class="filter-tab" data-filter="new">New</button>
          <button class="filter-tab" data-filter="in_progress">In Progress</button>
          <button class="filter-tab" data-filter="ready">Ready</button>
          <button class="filter-tab" data-filter="picked_up">Picked Up</button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="pos-content" style="padding-top: var(--space-4);">
        
        <!-- Kanban View -->
        <div id="kanban-view" class="kanban-board">
          <!-- Columns will be rendered by JS -->
        </div>

        <!-- List View (hidden by default) -->
        <div id="list-view" style="display: none;">
          <div class="card">
            <table class="table" id="tickets-table">
              <thead>
                <tr>
                  <th>Ticket</th>
                  <th>Customer</th>
                  <th>Device</th>
                  <th>Issue</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tickets-tbody">
                <!-- Rows rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-state-icon">üé´</div>
          <h3 class="empty-state-title">No tickets yet</h3>
          <p class="empty-state-text">Create your first repair ticket to get started</p>
          <a href="ticket-new.html" class="btn btn-primary">+ New Ticket</a>
        </div>
      </div>
    </main>
  </div>

  <script src="js/pos-data.js"></script>
  <script src="js/pos-core.js"></script>
  <script>
    // State
    let currentView = 'kanban';
    let currentFilter = 'all';
    let searchQuery = '';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadTickets();
      setupEventListeners();
      updateStats();
    });

    function setupEventListeners() {
      // View toggle
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderTickets();
        });
      });

      // Filter tabs
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderTickets();
        });
      });

      // Search
      document.getElementById('search-input').addEventListener('input', POS.debounce((e) => {
        searchQuery = e.target.value;
        renderTickets();
      }, 300));
    }

    function loadTickets() {
      renderTickets();
    }

    function getFilteredTickets() {
      let tickets = POS_DATA.getTickets();

      // Apply search
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        tickets = tickets.filter(t =>
          t.id.toLowerCase().includes(q) ||
          t.customer?.name?.toLowerCase().includes(q) ||
          t.customer?.phone?.includes(q) ||
          t.device?.model?.toLowerCase().includes(q)
        );
      }

      // Apply filter
      if (currentFilter !== 'all') {
        if (currentFilter === 'in_progress') {
          tickets = tickets.filter(t => ['diagnosed', 'waiting_parts', 'in_repair'].includes(t.status));
        } else {
          tickets = tickets.filter(t => t.status === currentFilter);
        }
      }

      return tickets;
    }

    function renderTickets() {
      const tickets = getFilteredTickets();
      
      // Update counts
      document.getElementById('ticket-count').textContent = tickets.length;
      document.getElementById('header-count').textContent = tickets.length;

      // Show/hide empty state
      const isEmpty = tickets.length === 0;
      document.getElementById('empty-state').style.display = isEmpty ? 'block' : 'none';
      document.getElementById('kanban-view').style.display = isEmpty ? 'none' : (currentView === 'kanban' ? 'flex' : 'none');
      document.getElementById('list-view').style.display = isEmpty ? 'none' : (currentView === 'list' ? 'block' : 'none');

      if (isEmpty) return;

      if (currentView === 'kanban') {
        renderKanban(tickets);
      } else {
        renderList(tickets);
      }
    }

    function renderKanban(tickets) {
      const columns = [
        { status: 'new', label: 'New', icon: 'üì•' },
        { status: 'diagnosed', label: 'Diagnosed', icon: 'üîç' },
        { status: 'waiting_parts', label: 'Waiting Parts', icon: 'üì¶' },
        { status: 'in_repair', label: 'In Repair', icon: 'üîß' },
        { status: 'ready', label: 'Ready', icon: '‚úÖ' },
        { status: 'picked_up', label: 'Picked Up', icon: 'üí∞' }
      ];

      const board = document.getElementById('kanban-view');
      board.innerHTML = columns.map(col => {
        const colTickets = tickets.filter(t => t.status === col.status);
        return `
          <div class="kanban-column" data-status="${col.status}">
            <div class="kanban-column-header">
              <span class="kanban-column-icon">${col.icon}</span>
              <span class="kanban-column-title">${col.label}</span>
              <span class="kanban-column-count">${colTickets.length}</span>
            </div>
            <div class="kanban-column-body">
              ${colTickets.map(t => renderKanbanTicket(t)).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      board.querySelectorAll('.kanban-ticket').forEach(card => {
        card.addEventListener('click', () => {
          window.location.href = `ticket-view.html?id=${card.dataset.id}`;
        });
      });
    }

    function renderKanbanTicket(ticket) {
      const priorityClass = ticket.priority || 'normal';
      return `
        <div class="kanban-ticket priority-${priorityClass}" data-id="${ticket.id}">
          <div class="kanban-ticket-header">
            <span class="kanban-ticket-id">${ticket.id}</span>
            <span class="kanban-ticket-time">${POS.timeAgo(ticket.createdAt)}</span>
          </div>
          <div class="kanban-ticket-customer">${POS.escapeHtml(ticket.customer?.name || 'Unknown')}</div>
          <div class="kanban-ticket-device">${POS.getDeviceIcon(ticket.device?.type)} ${POS.escapeHtml(ticket.device?.model || 'Unknown Device')}</div>
          <div class="kanban-ticket-footer">
            <span class="kanban-ticket-issue">${POS.escapeHtml(ticket.repair?.type?.replace(/_/g, ' ') || 'Repair')}</span>
            <span class="kanban-ticket-price">${POS.formatCurrency(ticket.pricing?.total)}</span>
          </div>
        </div>
      `;
    }

    function renderList(tickets) {
      const tbody = document.getElementById('tickets-tbody');
      tbody.innerHTML = tickets.map(t => `
        <tr onclick="window.location.href='ticket-view.html?id=${t.id}'" style="cursor:pointer;">
          <td>
            <div style="font-family: var(--font-mono); font-weight: 600; color: var(--primary);">${t.id}</div>
          </td>
          <td>
            <div style="font-weight: 500;">${POS.escapeHtml(t.customer?.name || 'Unknown')}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${t.customer?.phone || ''}</div>
          </td>
          <td>
            <div>${POS.getDeviceIcon(t.device?.type)} ${POS.escapeHtml(t.device?.model || 'Unknown')}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${t.device?.brand || ''}</div>
          </td>
          <td>${POS.escapeHtml(t.repair?.type?.replace(/_/g, ' ') || 'Repair')}</td>
          <td><span class="status-pill ${POS.getStatusClass(t.status)}">${POS.getStatusLabel(t.status)}</span></td>
          <td style="font-family: var(--font-mono); font-weight: 600;">${POS.formatCurrency(t.pricing?.total)}</td>
          <td style="color: var(--text-muted);">${POS.timeAgo(t.createdAt)}</td>
          <td>
            <button class="btn btn-ghost btn-icon" onclick="event.stopPropagation(); window.location.href='ticket-view.html?id=${t.id}'">‚Üí</button>
          </td>
        </tr>
      `).join('');
    }

    function updateStats() {
      const stats = POS_DATA.getStats();
      document.getElementById('stat-today').textContent = stats.todayTickets;
      document.getElementById('stat-revenue').textContent = POS.formatCurrency(stats.todayRevenue);
    }
  </script>
</body>
</html>

